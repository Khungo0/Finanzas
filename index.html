<script type="module">
        // --- 1. CONFIGURACIÓN DE SUPABASE Y LIBRERÍAS ---
        let createIcons; // Declarar aquí
        try {
            const lucide = await import('https://cdn.jsdelivr.net/npm/lucide@latest/dist/esm/lucide.js');
            // Asignar solo las funciones necesarias
            createIcons = lucide.createIcons;
            // Definir un objeto global de iconos para que createIcons() funcione
            window.lucideIcons = {
                Home: lucide.Home,
                DollarSign: lucide.DollarSign,
                ArrowUpCircle: lucide.ArrowUpCircle,
                ArrowDownCircle: lucide.ArrowDownCircle,
                PlusCircle: lucide.PlusCircle,
                Trash2: lucide.Trash2,
                Gem: lucide.Gem,
                ListChecks: lucide.ListChecks,
                XCircle: lucide.XCircle,
                Wallet: lucide.Wallet,
                Pencil: lucide.Pencil,
                Edit: lucide.Edit,
                Repeat: lucide.Repeat
            };
        } catch (e) {
            console.error("Error crítico al cargar Lucide icons:", e);
            // Fallback: si Lucide falla, define createIcons como una función vacía
            // para que el resto del script no falle.
            createIcons = () => {}; 
        }

        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');

        // TUS CREDENCIALES DE SUPABASE (INTEGRADAS)
        const SUPABASE_URL = 'https://agbkeubwhbzjyrmzzkjd.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnYmtldWJ3aGJ6anlybXp6a2pkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MTA3ODksImV4cCI6MjA3Njk4Njc4OX0.pj3-hUlKcSb3BDuOvhOQD7sMzf5qONQdiLw9nT5MJis'; 
        const TABLA_TRANSACCIONES = 'transacciones';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // --- 2. VARIABLES Y ESTADO ---
        let todasTransacciones = []; 
        let transaccionesMesActual = []; 
        let mesSeleccionado = ''; 
        let resumenMensual = {}; 
        
        let categorias = JSON.parse(localStorage.getItem('finanzasCategorias')) || {
            ingreso: ['Salario', 'Freelance', 'Inversiones', 'Venta', 'Regalo', 'Otro Ingreso'],
            gasto: ['Vivienda', 'Alimentación', 'Transporte', 'Ocio', 'Deudas', 'Servicios', 'Salud', 'Educación', 'Otro Gasto'],
            ahorro: ['Fondo de Emergencia', 'Meta Viaje', 'Meta Casa', 'Inversión Crecimiento']
        };
        
        // --- CONFIGURACIÓN DE CUENTAS ---
        const NOMBRE_CUENTA_AHORROS_CLAVE = 'Cuenta de Ahorros'; 
        let nombreCuentaAhorrosActual = localStorage.getItem('finanzasNombreAhorrosActual') || NOMBRE_CUENTA_AHORROS_CLAVE;

        let cuentas = JSON.parse(localStorage.getItem('finanzasCuentas')) || [
            'Efectivo', 'Mercantil', 'Binance', 'Zinli', nombreCuentaAhorrosActual
        ];
        
        // Asegurar la consistencia de la cuenta de ahorro al inicio
        (function initialAccountSetup() {
            const index = cuentas.indexOf(nombreCuentaAhorrosActual);
            if (index === -1) {
                 cuentas.push(nombreCuentaAhorrosActual);
            } else if (index !== cuentas.length - 1) {
                cuentas.splice(index, 1);
                cuentas.push(nombreCuentaAhorrosActual);
            }
        })();
        // --- FIN CONFIGURACIÓN DE CUENTAS ---

        // Referencias del DOM
        const tipoSelect = document.getElementById('tipo');
        const categoriaSelect = document.getElementById('categoria');
        const cuentaSelect = document.getElementById('cuenta'); 
        const formTransaccion = document.getElementById('form-transaccion');
        const listaTransaccionesEl = document.getElementById('lista-transacciones');
        const gastosPorCategoriaEl = document.getElementById('gastos-por-categoria');
        const gastoBarTotalEl = document.getElementById('gasto-bar-total');
        const gastoPorcentajeEl = document.getElementById('gasto-porcentaje');
        const formMessageEl = document.getElementById('form-message');
        const fechaInput = document.getElementById('fecha');
        const selectorMesEl = document.getElementById('selector-mes');
        const ahorroPorcentajeInput = document.getElementById('ahorro-porcentaje'); 
        const ahorroSugerenciaContainer = document.getElementById('ahorro-sugerencia-container');
        const montoInput = document.getElementById('monto'); // ¡NUEVA REFERENCIA AGREGADA!
        
        // DOM Intercambio (NUEVO)
        const formIntercambio = document.getElementById('form-intercambio');
        const cuentaOrigenSelect = document.getElementById('cuenta-origen');
        const cuentaDestinoSelect = document.getElementById('cuenta-destino');
        const montoEnviadoInput = document.getElementById('monto-enviado'); 
        const montoRecibidoInput = document.getElementById('monto-recibido'); 
        const intercambioMessageEl = document.getElementById('intercambio-message');


        // Referencias del DOM de UI Avanzada
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const categoriasListas = {
            ingreso: document.getElementById('lista-ingreso'),
            gasto: document.getElementById('lista-gasto'),
            ahorro: document.getElementById('lista-ahorro'),
            cuenta: document.getElementById('lista-cuenta') 
        };
        const categoriasInputs = {
            ingreso: document.getElementById('input-ingreso'),
            gasto: document.getElementById('input-gasto'),
            ahorro: document.getElementById('input-ahorro'),
            cuenta: document.getElementById('input-cuenta') 
        };
        const categoriasCounts = {
            ingreso: document.getElementById('count-ingreso'),
            gasto: document.getElementById('count-gasto'),
            ahorro: document.getElementById('count-ahorro'),
            cuenta: document.getElementById('count-cuenta') 
        };
        const btnAgregarGeneral = document.querySelectorAll('.btn-agregar-general');
        
        const modalContainerConfirm = document.getElementById('modal-container');
        const modalConfirmDelete = document.getElementById('modal-confirm');
        const modalCancelConfirm = document.getElementById('modal-cancel');
        const modalContainerEdicion = document.getElementById('modal-container-edicion');
        const formEdicion = document.getElementById('form-edicion');
        const modalCancelEdicion = document.getElementById('modal-cancel-edicion');
        const editTipoSelect = document.getElementById('edit-tipo');
        const editCuentaSelect = document.getElementById('edit-cuenta');
        const editCategoriaSelect = document.getElementById('edit-categoria');
        const editMontoInput = document.getElementById('edit-monto');
        const editDescripcionInput = document.getElementById('edit-descripcion');
        const editFechaInput = document.getElementById('edit-fecha');
        const editIdInput = document.getElementById('edit-id');

        
        // --- 3. LÓGICA DE UTILIDAD Y CÁLCULO ---
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('es-US', { style: 'currency', currency: 'USD' }).format(amount);
        };
        
        // MODIFICADA: Implementación de cálculo bidireccional (Monto ↔ Porcentaje)
        function calcularSugerenciaAhorro(changedInput = 'porcentaje') {
            const tipo = tipoSelect.value;
            const ingresosTotales = resumenMensual.ingresosTotales || 0;
            
            if (tipo === 'ahorro') {
                ahorroSugerenciaContainer.classList.remove('hidden');
                
                if (ingresosTotales > 0) {
                    
                    if (changedInput === 'monto') {
                        // MODO: Monto introducido -> Calcular Porcentaje
                        const monto = parseFloat(montoInput.value) || 0;
                        let porcentajeCalculado = 0;
                        if (monto > 0) {
                            porcentajeCalculado = (monto / ingresosTotales) * 100;
                        }
                        // Limitar al 100% y actualizar el porcentaje
                        porcentajeCalculado = Math.min(porcentajeCalculado, 100);
                        ahorroPorcentajeInput.value = porcentajeCalculado.toFixed(0);
                        
                    } else {
                        // MODO: Porcentaje introducido -> Calcular Monto (comportamiento por defecto)
                        const porcentaje = parseFloat(ahorroPorcentajeInput.value) || 0;
                        const porcentajeValido = isNaN(porcentaje) || porcentaje < 0 ? 0 : porcentaje;
                        const montoSugerido = ingresosTotales * (porcentajeValido / 100);
                        
                        if (montoSugerido > 0) {
                            montoInput.value = montoSugerido.toFixed(2);
                        } else {
                            montoInput.value = ''; 
                        }
                    }
                    
                    // Actualizar el texto de sugerencia/informativo
                    const porcentajeFinal = parseFloat(ahorroPorcentajeInput.value) || 0;
                    const montoFinal = parseFloat(montoInput.value) || 0;
                    
                    document.getElementById('ahorro-sugerencia-monto').textContent = `Monto: ${formatCurrency(montoFinal)} (${porcentajeFinal.toFixed(1)}% de ${formatCurrency(ingresosTotales)})`;
                    
                } else {
                    // Si no hay ingresos, se muestra el mensaje estándar
                    document.getElementById('ahorro-sugerencia-monto').textContent = `Sugerencia: ${formatCurrency(0.00)} (No hay ingresos registrados en el mes)`;
                }
            } else {
                ahorroSugerenciaContainer.classList.add('hidden');
            }
        }
        
        function calcularSaldosCuentas() {
            const saldos = {};
            cuentas.forEach(c => saldos[c] = 0);
            
            const nombreCuentaAhorros = nombreCuentaAhorrosActual; 
            
            todasTransacciones.forEach(t => {
                if (t.cuenta && saldos.hasOwnProperty(t.cuenta)) {
                    
                    if (t.tipo === 'ingreso' || t.tipo === 'intercambio_in') { 
                        saldos[t.cuenta] += t.monto;
                    } 
                    
                    else if (t.tipo === 'gasto' || t.tipo === 'intercambio_out') { 
                        saldos[t.cuenta] -= t.monto;
                    } 
                    
                    else if (t.tipo === 'ahorro') {
                        
                        if (t.cuenta === nombreCuentaAhorros) {
                            saldos[t.cuenta] += t.monto;
                        } else {
                            saldos[t.cuenta] -= t.monto;
                        }
                    }
                }
            });
            return saldos;
        }

        // --- CÓDIGO NUEVO (CORREGIDO) ---
        function calcularResumenMensual() {
            let totalEntradasMes = 0; // Flujo de entrada total (para balance)
            let totalSalidasMes = 0;  // Flujo de salida total (para balance)
            
            let ingresosRealesMes = 0; // Para la tarjeta "Ingresos"
            let gastosRealesMes = 0;   // Para la tarjeta "Gastos" (incluye Ahorro)

            let gastosPorCategoria = {}; // Solo para 'gasto' real
            let ingresosPorCategoria = {}; // <-- ¡NUEVA VARIABLE!
            let ahorroAcumulado = 0;
            let saldoInicial = 0;
            
            const mesActualSeleccionado = mesSeleccionado;

            todasTransacciones.forEach(t => {
                const monto = t.monto;

                // El ahorro acumulado total es histórico
                if (t.tipo === 'ahorro') {
                    ahorroAcumulado += monto;
                }

                // 1. CÁLCULO DEL SALDO INICIAL (Transacciones de meses anteriores)
                // Esta lógica está bien, ya que los intercambios afectan el saldo
                if (t.mesAnio < mesActualSeleccionado) {
                    if (t.tipo === 'ingreso' || t.tipo === 'intercambio_in') {
                        saldoInicial += monto;
                    } else if (t.tipo === 'gasto' || t.tipo === 'ahorro' || t.tipo === 'intercambio_out') {
                        saldoInicial -= monto;
                    }
                
                // 2. CÁLCULO DEL MES ACTUAL
                } else if (t.mesAnio === mesActualSeleccionado) {
                    
                    // --- Flujos de ENTRADA (para el balance) ---
                    if (t.tipo === 'ingreso' || t.tipo === 'intercambio_in') { 
                        totalEntradasMes += monto;
                        
                        // Solo contamos 'ingreso' para la tarjeta de resumen
                        if (t.tipo === 'ingreso') {
                            ingresosRealesMes += monto;
                            // El gráfico de categorías SÍ debe incluir solo ingresos reales
                            ingresosPorCategoria[t.categoria] = (ingresosPorCategoria[t.categoria] || 0) + monto; // <-- ¡NUEVO CÁLCULO!
                        }
                        
                    // --- Flujos de SALIDA (para el balance) ---
                    } else if (t.tipo === 'gasto' || t.tipo === 'ahorro' || t.tipo === 'intercambio_out') {
                        totalSalidasMes += monto; 
                        
                        // Solo contamos 'gasto' y 'ahorro' para la tarjeta de resumen
                        if (t.tipo === 'gasto') {
                            gastosRealesMes += monto;
                            // El gráfico de categorías SÍ debe incluir solo gastos
                            gastosPorCategoria[t.categoria] = (gastosPorCategoria[t.categoria] || 0) + monto;
                        } else if (t.tipo === 'ahorro') {
                            // El ahorro también lo contamos como "gasto" en el resumen
                            gastosRealesMes += monto; 
                        }
                    }
                }
            });
            
            // El Saldo Final (balanceNeto) se calcula con los flujos TOTALES
            const balanceNeto = saldoInicial + totalEntradasMes - totalSalidasMes;

            // Devolvemos los valores REALES para las tarjetas de resumen
            return { 
                ingresosTotales: ingresosRealesMes, 
                gastosTotales: gastosRealesMes, 
                balanceNeto: balanceNeto, 
                saldoInicial: saldoInicial, 
                gastosPorCategoria: gastosPorCategoria, 
                ingresosPorCategoria: ingresosPorCategoria, // <-- ¡NUEVO RETORNO!
                ahorroAcumulado: ahorroAcumulado 
            };
        }

        // --- 4. FUNCIONES CRUD CON SUPABASE ---
        
        function guardarConfiguracionLocal() {
             localStorage.setItem('finanzasCategorias', JSON.stringify(categorias));
             localStorage.setItem('finanzasCuentas', JSON.stringify(cuentas));
             localStorage.setItem('finanzasNombreAhorrosActual', nombreCuentaAhorrosActual);
        }
        
        async function cargarDatosDesdeSupabase() {
            // Selecciona 'cuenta' que es la columna requerida
            const { data, error } = await supabase
                .from(TABLA_TRANSACCIONES)
                .select('id, tipo, categoria, descripcion, monto, fecha, cuenta'); 
            
            if (error) {
                console.error("Error al cargar datos de Supabase:", error);
                document.getElementById('lista-transacciones').innerHTML = `<tr><td colspan="7" class="p-4 text-center text-red-500">Error al cargar datos: ${error.message}. ¿Añadiste la columna 'cuenta' a la tabla 'transacciones'?</td></tr>`;
                todasTransacciones = [];
            } else {
                todasTransacciones = data.map(t => ({
                    ...t,
                    monto: parseFloat(t.monto), 
                    mesAnio: t.fecha.substring(0, 7) 
                }));
            }
            
            filtrarYRenderizar();
        }

        // FUNCIÓN CLAVE: Ahora maneja inserciones a Supabase con todos los campos
        async function guardarTransaccion(transaccion, esIntercambio = false) {
            
            const categoriaFinal = esIntercambio ? 'Intercambio' : transaccion.categoria;

            const { error } = await supabase
                .from(TABLA_TRANSACCIONES)
                .insert([{
                    tipo: transaccion.tipo,
                    categoria: categoriaFinal,
                    descripcion: transaccion.descripcion,
                    monto: parseFloat(transaccion.monto),
                    fecha: transaccion.fecha,
                    cuenta: transaccion.cuenta, 
                }]);
                
            if (error) {
                console.error("Error al guardar en Supabase:", error);
                return { success: false, error: error };
            } 
            return { success: true };
        }

        // FUNCIÓN CLAVE: Manejo de Intercambios (Doble Inserción a Supabase)
        async function manejarIntercambio(origen, destino, montoEnviado, montoRecibido, fecha) {
            if (origen === destino) {
                intercambioMessageEl.textContent = "Error: Las cuentas de origen y destino no pueden ser iguales.";
                intercambioMessageEl.classList.remove('hidden', 'text-green-500');
                intercambioMessageEl.classList.add('text-red-500');
                return;
            }
            
            const montoEnviadoFloat = parseFloat(montoEnviado);
            const montoRecibidoFloat = parseFloat(montoRecibido);
            const comision = montoEnviadoFloat - montoRecibidoFloat;
            
            if (comision < 0) {
                 intercambioMessageEl.textContent = "Error: El monto recibido no puede ser mayor que el monto enviado.";
                 intercambioMessageEl.classList.remove('hidden', 'text-green-500');
                 intercambioMessageEl.classList.add('text-red-500');
                 return;
            }
            
            // 1. Transacción de Salida (Resta el MONTO ENVIADO de la cuenta de origen)
            const resultOut = await guardarTransaccion({
                tipo: 'intercambio_out',
                cuenta: origen,
                monto: montoEnviadoFloat, 
                descripcion: `Transferencia a ${destino} (Comisión: ${formatCurrency(comision)})`,
                fecha: fecha,
            }, true);
            
            if (!resultOut.success) {
                 intercambioMessageEl.textContent = `Error al guardar salida: ${resultOut.error.message}`;
                 intercambioMessageEl.classList.add('text-red-500');
                 return;
            }

            // 2. Transacción de Entrada (Suma el MONTO RECIBIDO a la cuenta de destino)
            const resultIn = await guardarTransaccion({
                tipo: 'intercambio_in',
                cuenta: destino,
                monto: montoRecibidoFloat, 
                descripcion: `Transferencia de ${origen} (Comisión: ${formatCurrency(comision)})`,
                fecha: fecha,
            }, true);
            
            if (!resultIn.success) {
                 intercambioMessageEl.textContent = `Error al guardar entrada: ${resultIn.error.message}`;
                 intercambioMessageEl.classList.add('text-red-500');
                 return;
            }
            

            await cargarDatosDesdeSupabase();
            
            intercambioMessageEl.textContent = "¡Intercambio realizado con éxito!";
            intercambioMessageEl.classList.remove('hidden', 'text-red-500');
            intercambioMessageEl.classList.add('text-green-500');
            formIntercambio.reset();
            setTimeout(() => intercambioMessageEl.classList.add('hidden'), 3000);
        }


        async function eliminarTransaccion(id) {
            
            const { error } = await supabase
                .from(TABLA_TRANSACCIONES)
                .delete()
                .eq('id', id); 

            if (error) {
                console.error("Error al eliminar en Supabase:", error);
            } else {
                await cargarDatosDesdeSupabase();
            }
        }
        
        // --- 5. LÓGICA DE FILTRADO Y CÁLCULO ---

        function filtrarYRenderizar() {
            transaccionesMesActual = todasTransacciones
                .filter(t => t.mesAnio === mesSeleccionado)
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                
            resumenMensual = calcularResumenMensual();

            const { ingresosTotales, gastosTotales, balanceNeto, saldoInicial, gastosPorCategoria, ahorroAcumulado } = resumenMensual;
            renderizarDashboard(ingresosTotales, gastosTotales, balanceNeto, saldoInicial, gastosPorCategoria, ahorroAcumulado);
            renderizarListaTransacciones();
            calcularSugerenciaAhorro(); 
            renderizarResumenCuentas(); 
        }


        // --- 6. LÓGICA DE RENDERIZACIÓN DE LA UI ---
        
        function inicializarSelectorMes() {
            const hoy = new Date();
            const year = hoy.getFullYear();
            const month = hoy.getMonth();
            
            let opcionesHTML = '';
            const mesesNombre = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

            for (let i = 0; i <= 5; i++) {
                const fecha = new Date(year, month + i, 1);
                const valor = `${fecha.getFullYear()}-${(fecha.getMonth() + 1).toString().padStart(2, '0')}`;
                const nombre = `${mesesNombre[fecha.getMonth()]} ${fecha.getFullYear()}`;
                opcionesHTML += `<option value="${valor}">${nombre}</option>`;
            }

            selectorMesEl.innerHTML = opcionesHTML;
            mesSeleccionado = `${year}-${(month + 1).toString().padStart(2, '0')}`;
            selectorMesEl.value = mesSeleccionado;
            fechaInput.value = hoy.toISOString().substring(0, 10);

            selectorMesEl.addEventListener('change', (e) => {
                mesSeleccionado = e.target.value;
                filtrarYRenderizar();
            });
        }
        
        function inicializarPestanas() {
            document.getElementById('tab-resumen').classList.add('border-indigo-500', 'text-indigo-600');
            document.getElementById('seccion-resumen').classList.remove('hidden');

            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.dataset.target;

                    tabContents.forEach(content => content.classList.add('hidden'));
                    tabButtons.forEach(btn => {
                        btn.classList.remove('border-indigo-500', 'text-indigo-600');
                        btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    });

                    document.getElementById(targetId).classList.remove('hidden');
                    button.classList.add('border-indigo-500', 'text-indigo-600');
                    button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

                    if (targetId === 'seccion-categorias') {
                        renderizarCategorias();
                        renderizarCuentas(); 
                    }
                    
                    if (targetId === 'seccion-resumen') {
                         actualizarCategoriasYCuentas(); 
                    }
                });
            });
        }
        
        function renderizarResumenCuentas() {
            const saldos = calcularSaldosCuentas();
            const resumenCuentasEl = document.getElementById('resumen-cuentas');
            resumenCuentasEl.innerHTML = '';
            
            const saldosOrdenados = cuentas.map(c => [c, saldos[c] !== undefined ? saldos[c] : 0]);

            if (saldosOrdenados.length === 0) {
                resumenCuentasEl.innerHTML = '<p class="text-gray-500">No hay cuentas configuradas o transacciones registradas.</p>';
                return;
            }

            saldosOrdenados.forEach(([cuenta, saldo]) => {
                const color = saldo >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                const html = `
                    <div class="${color} p-3 rounded-lg border border-gray-200">
                        <p class="text-sm font-semibold">${cuenta}</p>
                        <p class="text-xl font-bold mt-1">${formatCurrency(saldo)}</p>
                    </div>
                `;
                resumenCuentasEl.insertAdjacentHTML('beforeend', html);
            });
        }

        function renderizarDashboard(ingresosTotales, gastosTotales, balanceNeto, saldoInicial, gastosPorCategoria, ahorroAcumulado) {
            document.getElementById('saldo-inicial').textContent = formatCurrency(saldoInicial);
            document.getElementById('ingresos-totales').textContent = formatCurrency(ingresosTotales);
            document.getElementById('gastos-totales').textContent = formatCurrency(gastosTotales);
            document.getElementById('ahorro-acumulado-total').textContent = formatCurrency(ahorroAcumulado); 
            
            const saldoInicialEl = document.getElementById('saldo-inicial');
            saldoInicialEl.classList.remove('text-green-600', 'text-red-600', 'text-gray-800');
            if (saldoInicial > 0) saldoInicialEl.classList.add('text-green-600'); 
            else if (saldoInicial < 0) saldoInicialEl.classList.add('text-red-600'); 
            else saldoInicialEl.classList.add('text-gray-800');

            const balanceEl = document.getElementById('balance-neto');
            balanceEl.textContent = formatCurrency(balanceNeto);
            balanceEl.classList.remove('text-green-600', 'text-red-600', 'text-blue-600');
            if (balanceNeto > 0) balanceEl.classList.add('text-green-600'); 
            else if (balanceNeto < 0) balanceEl.classList.add('text-red-600'); 
            else balanceEl.classList.add('text-blue-600');
            
            let totalDisponibleParaGasto = saldoInicial + ingresosTotales;
            let porcentajeGasto = 0;
            if (totalDisponibleParaGasto > 0) porcentajeGasto = (gastosTotales / totalDisponibleParaGasto) * 100;
            porcentajeGasto = Math.min(porcentajeGasto, 100); 

            gastoBarTotalEl.style.width = `${porcentajeGasto}%`;
            gastoPorcentajeEl.textContent = `${porcentajeGasto.toFixed(1)}% de los fondos disponibles gastados`;
            gastoBarTotalEl.classList.remove('bg-red-500', 'bg-yellow-500', 'bg-indigo-500');
            if (porcentajeGasto >= 80) gastoBarTotalEl.classList.add('bg-red-500'); 
            else if (porcentajeGasto > 50) gastoBarTotalEl.classList.add('bg-yellow-500'); 
            else gastoBarTotalEl.classList.add('bg-indigo-500');

            renderizarGastosPorCategoria(gastosPorCategoria, gastosTotales);
            // ¡NUEVA LLAMADA A FUNCIÓN!
            renderizarIngresosPorCategoria(resumenMensual.ingresosPorCategoria, ingresosTotales);
        }

        function renderizarGastosPorCategoria(gastosPorCategoria, gastosTotales) {
            gastosPorCategoriaEl.innerHTML = '';
            if (gastosTotales === 0) {
                gastosPorCategoriaEl.innerHTML = '<p class="text-gray-500 text-center py-4">No hay gastos reales (sin incluir ahorro) registrados en este mes.</p>';
                return;
            }
            const colores = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#0ea5e9', '#6366f1', '#a855f7', '#ec4899', '#f43f5e'];
            let colorIndex = 0;
            const categoriasOrdenadas = Object.entries(gastosPorCategoria).sort(([, a], [, b]) => b - a);

            categoriasOrdenadas.forEach(([categoria, monto]) => {
                const porcentaje = (monto / gastosTotales) * 100;
                const color = colores[colorIndex % colores.length];
                colorIndex++;
                const html = `
                    <div>
                        <div class="flex justify-between text-sm font-medium">
                            <span class="text-gray-700">${categoria}</span>
                            <span class="text-gray-600">${formatCurrency(monto)} (${porcentaje.toFixed(1)}%)</span>
                        </div>
                        <div class="category-bar-container bg-gray-200 mt-1">
                            <div class="category-bar-segment transition-all duration-500" style="width: ${porcentaje}%; background-color: ${color};"></div>
                        </div>
                    </div>
                `;
                gastosPorCategoriaEl.insertAdjacentHTML('beforeend', html);
            });
        }
        
        // ============ FUNCIÓN PARA RENDERIZAR INGRESOS ============
        function renderizarIngresosPorCategoria(ingresosPorCategoria, ingresosTotales) {
            const ingresosPorCategoriaEl = document.getElementById('ingresos-por-categoria'); // Referencia al nuevo DIV
            ingresosPorCategoriaEl.innerHTML = '';
            
            if (ingresosTotales === 0) {
                ingresosPorCategoriaEl.innerHTML = '<p class="text-gray-500 text-center py-4">No hay ingresos registrados en este mes.</p>';
                return;
            }
            
            // Nuevos colores para diferenciar los gráficos
            const colores = ['#22c55e', '#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5']; 
            let colorIndex = 0;
            const categoriasOrdenadas = Object.entries(ingresosPorCategoria).sort(([, a], [, b]) => b - a);

            categoriasOrdenadas.forEach(([categoria, monto]) => {
                const porcentaje = (monto / ingresosTotales) * 100;
                const color = colores[colorIndex % colores.length];
                colorIndex++;
                const html = `
                    <div>
                        <div class="flex justify-between text-sm font-medium">
                            <span class="text-gray-700">${categoria}</span>
                            <span class="text-gray-600">${formatCurrency(monto)} (${porcentaje.toFixed(1)}%)</span>
                        </div>
                        <div class="category-bar-container bg-gray-200 mt-1">
                            <div class="category-bar-segment transition-all duration-500" style="width: ${porcentaje}%; background-color: ${color};"></div>
                        </div>
                    </div>
                `;
                ingresosPorCategoriaEl.insertAdjacentHTML('beforeend', html);
            });
        }
        // =================================================================

        function renderizarListaTransacciones() {
            if (transaccionesMesActual.length === 0) {
                listaTransaccionesEl.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">No hay transacciones registradas para este mes.</td></tr>`;
                return;
            }

            listaTransaccionesEl.innerHTML = transaccionesMesActual.map(t => {
                const esIngreso = t.tipo === 'ingreso';
                const esAhorro = t.tipo === 'ahorro';
                const esIntercambio = t.tipo === 'intercambio_in' || t.tipo === 'intercambio_out';

                let montoClase;
                let tipoClase;
                let tipoTexto;

                if (esIntercambio) {
                    tipoClase = 'bg-gray-100 text-gray-800';
                    tipoTexto = t.tipo === 'intercambio_in' ? 'INTERCAMBIO (+)' : 'INTERCAMBIO (-)';
                    montoClase = 'text-gray-600 font-semibold'; 
                } else {
                    montoClase = esIngreso ? 'text-green-600 font-semibold' : esAhorro ? 'text-blue-600 font-semibold' : 'text-red-600 font-semibold';
                    tipoClase = esIngreso ? 'bg-green-100 text-green-800' : esAhorro ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800';
                    tipoTexto = esIngreso ? 'INGRESO' : esAhorro ? 'AHORRO' : 'GASTO';
                }
                

                return `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.fecha}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${tipoClase}">${tipoTexto}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${t.cuenta || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.categoria}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${t.descripcion}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm ${montoClase}">${formatCurrency(t.monto)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button data-id="${t.id}" class="btn-editar text-indigo-500 hover:text-indigo-700 transition" title="Editar Transacción">
                                <i data-lucide="pencil" class="w-5 h-5 inline-block"></i>
                            </button>
                            <button data-id="${t.id}" class="btn-eliminar text-red-500 hover:text-red-700 transition" title="Eliminar Transacción">
                                <i data-lucide="trash-2" class="w-5 h-5 inline-block"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            try {
                createIcons({ icons: window.lucideIcons }); 
            } catch (e) {
                 console.warn("Error al renderizar iconos de la tabla:", e.message);
            }
        }

        // --- 7. MANEJO DE EVENTOS ---

        function actualizarCategoriasYCuentas() {
            // Actualiza los selectores de categoría y cuenta en el formulario principal
            actualizarCategorias();
            
            // Actualiza los selectores de cuenta en el formulario de Intercambio
            const opcionesCuentas = cuentas.map(c => `<option value="${c}">${c}</option>`).join('');
            cuentaSelect.innerHTML = opcionesCuentas;
            cuentaOrigenSelect.innerHTML = opcionesCuentas;
            cuentaDestinoSelect.innerHTML = opcionesCuentas;
        }

        function actualizarCategorias() {
            const tipo = tipoSelect.value;
            const cats = categorias[tipo] || [];
            categoriaSelect.innerHTML = cats.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            calcularSugerenciaAhorro(); // Recalcula la sugerencia al cambiar el tipo
        }
        
        // --- FUNCIÓN CRUD LOCALES (para configuración) ---
        
        function guardarCuentas() {
            localStorage.setItem('finanzasCuentas', JSON.stringify(cuentas));
        }

        function guardarNombreCuentaAhorros(nuevoNombre) {
            localStorage.setItem('finanzasNombreAhorrosActual', nuevoNombre);
            nombreCuentaAhorrosActual = nuevoNombre;
        }

        // --- EVENT HANDLERS MODIFICADOS ---
        
        tipoSelect.addEventListener('change', actualizarCategorias);
        
        // NUEVO: Si cambias el MONTO, recalcula el PORCENTAJE
        montoInput.addEventListener('input', () => calcularSugerenciaAhorro('monto')); 
        
        // CORREGIDO: Si cambias el PORCENTAJE, recalcula el MONTO
        ahorroPorcentajeInput.addEventListener('input', () => calcularSugerenciaAhorro('porcentaje')); 

        formTransaccion.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fechaTransaccion = document.getElementById('fecha').value;
            const mesAnioTransaccion = fechaTransaccion.substring(0, 7);

            if (mesAnioTransaccion !== mesSeleccionado) {
                 formMessageEl.textContent = `Advertencia: La transacción es del mes ${mesAnioTransaccion}, pero estás viendo ${mesSeleccionado}. Se guardará.`;
                 formMessageEl.classList.remove('hidden', 'text-green-500');
                 formMessageEl.classList.add('text-red-500');
                 setTimeout(() => formMessageEl.classList.add('hidden'), 5000);
            }

            const transaccion = {
                tipo: tipoSelect.value,
                categoria: categoriaSelect.value,
                monto: parseFloat(document.getElementById('monto').value),
                descripcion: document.getElementById('descripcion').value.trim(),
                fecha: fechaTransaccion,
                cuenta: cuentaSelect.value, // CAMPO AÑADIDO PARA SUBIR A SUPABASE
            };

            if (transaccion.descripcion && transaccion.monto > 0 && transaccion.cuenta) {
                const result = await guardarTransaccion(transaccion);

                if (result.success) {
                    await cargarDatosDesdeSupabase(); 
                    formMessageEl.textContent = "¡Transacción guardada con éxito en la nube!";
                    formMessageEl.classList.remove('hidden', 'text-red-500');
                    formMessageEl.classList.add('text-green-500');
                    formTransaccion.reset();
                    fechaInput.value = new Date().toISOString().substring(0, 10);
                    setTimeout(() => formMessageEl.classList.add('hidden'), 3000);
                } else {
                    formMessageEl.textContent = `Error al guardar: ${result.error.message}. ¿Añadiste la columna 'cuenta' a Supabase?`;
                    formMessageEl.classList.remove('hidden', 'text-green-500');
                    formMessageEl.classList.add('text-red-500');
                }
            } else {
                formMessageEl.textContent = "Por favor, complete todos los campos (incluida la cuenta) correctamente.";
                formMessageEl.classList.remove('hidden', 'text-green-500');
                formMessageEl.classList.add('text-red-500');
            }
        });
        
        // Evento de Intercambio (MODIFICADO)
        formIntercambio.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const origen = cuentaOrigenSelect.value;
            const destino = cuentaDestinoSelect.value;
            const montoEnviado = montoEnviadoInput.value;
            const montoRecibido = montoRecibidoInput.value;
            const fecha = new Date().toISOString().substring(0, 10);
            
            const montoEnviadoFloat = parseFloat(montoEnviado);
            const montoRecibidoFloat = parseFloat(montoRecibido);
            
            if (montoEnviadoFloat > 0 && montoRecibidoFloat >= 0 && montoEnviadoFloat >= montoRecibidoFloat) {
                 manejarIntercambio(origen, destino, montoEnviadoFloat, montoRecibidoFloat, fecha);
            } else {
                intercambioMessageEl.textContent = "Error: El monto enviado debe ser mayor o igual al recibido, y ambos válidos.";
                intercambioMessageEl.classList.remove('hidden', 'text-green-500');
                intercambioMessageEl.classList.add('text-red-500');
            }
        });

        // --- LISTENERS DE ACCIONES DE LA TABLA Y MODALES ---

        listaTransaccionesEl.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.btn-eliminar');
            const editButton = e.target.closest('.btn-editar'); // CORREGIDO: Listener de Edición

            if (deleteButton) {
                const id = deleteButton.dataset.id;
                mostrarModalConfirmacion(id);
            }
            if (editButton) { 
                const id = editButton.dataset.id;
                mostrarModalEdicion(id);
            }
        });

        let idAeliminar = null;
        function mostrarModalConfirmacion(id) {
            idAeliminar = id;
            modalContainerConfirm.classList.remove('hidden');
            modalContainerConfirm.classList.add('flex');
        }

        modalCancelConfirm.addEventListener('click', () => {
            modalContainerConfirm.classList.remove('flex');
            modalContainerConfirm.classList.add('hidden');
            idAeliminar = null;
        });

        modalConfirmDelete.addEventListener('click', () => {
            if (idAeliminar) {
                eliminarTransaccion(idAeliminar);
            }
            modalContainerConfirm.classList.remove('flex');
            modalContainerConfirm.classList.add('hidden');
            idAeliminar = null;
        });
        
        function actualizarOpcionesEdicion(currentTipo, currentCategoria, currentCuenta) {
            
            editCuentaSelect.innerHTML = cuentas.map(c => 
                `<option value="${c}" ${c === currentCuenta ? 'selected' : ''}>${c}</option>`
            ).join('');

            const llenarCategorias = (tipo) => {
                const cats = categorias[tipo] || [];
                editCategoriaSelect.innerHTML = cats.map(cat => 
                    `<option value="${cat}" ${cat === currentCategoria ? 'selected' : ''}>${cat}</option>`
                ).join('');
            };

            editTipoSelect.value = currentTipo;
            llenarCategorias(currentTipo);

            editTipoSelect.onchange = null; 
            editTipoSelect.onchange = () => {
                const nuevoTipo = editTipoSelect.value;
                llenarCategorias(nuevoTipo);
            };
        }
        
        formEdicion.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const transaccionEditada = {
                id: editIdInput.value,
                tipo: editTipoSelect.value,
                cuenta: editCuentaSelect.value,
                categoria: editCategoriaSelect.value,
                monto: parseFloat(editMontoInput.value),
                descripcion: editDescripcionInput.value.trim(),
                fecha: editFechaInput.value,
            };

            if (transaccionEditada.descripcion && transaccionEditada.monto > 0 && transaccionEditada.cuenta) {
                actualizarTransaccionSupabase(transaccionEditada);
            } else {
                alert("Por favor, complete todos los campos correctamente en el formulario de edición.");
            }
        });
        
        async function actualizarTransaccionSupabase(transaccion) {
             const { error } = await supabase
                .from(TABLA_TRANSACCIONES)
                .update({ 
                    tipo: transaccion.tipo,
                    categoria: transaccion.categoria,
                    monto: transaccion.monto,
                    descripcion: transaccion.descripcion,
                    fecha: transaccion.fecha,
                    cuenta: transaccion.cuenta
                 })
                .eq('id', transaccion.id);

            if (error) {
                console.error("Error al actualizar en Supabase:", error);
                alert("Error al actualizar: " + error.message);
            } else {
                modalContainerEdicion.classList.add('hidden');
                await cargarDatosDesdeSupabase();
            }
        }


        modalCancelEdicion.addEventListener('click', () => {
            modalContainerEdicion.classList.remove('flex');
            modalContainerEdicion.classList.add('hidden');
            editTipoSelect.onchange = null; 
        });
        
        function mostrarModalEdicion(id) {
const transaccion = todasTransacciones.find(t => t.id === id);            if (!transaccion) return;

            editIdInput.value = transaccion.id;
            editMontoInput.value = transaccion.monto.toFixed(2);
            editDescripcionInput.value = transaccion.descripcion;
            editFechaInput.value = transaccion.fecha;
            
            actualizarOpcionesEdicion(transaccion.tipo, transaccion.categoria, transaccion.cuenta);
            
            modalContainerEdicion.classList.remove('hidden');
            modalContainerEdicion.classList.add('flex');
        }

        // --- Funciones para la pestaña Administrar Datos (DRAG & DROP y Edición) ---

        function agregarGeneral(tipo, nombre) {
            nombre = nombre.trim();
            if (!nombre) return false;
            
            let array;
            let guardarFn;

            if (tipo === 'cuenta') {
                array = cuentas;
                guardarFn = guardarCuentas;
            } else {
                array = categorias[tipo];
                guardarFn = guardarConfiguracionLocal;
            }
            
            if (tipo === 'cuenta' && (nombre === NOMBRE_CUENTA_AHORROS_CLAVE || nombre === nombreCuentaAhorrosActual)) {
                 alert("No puedes agregar otra cuenta con ese nombre reservado para ahorros.");
                 return false;
            }

            if (!array.includes(nombre)) {
                
                const indexAhorros = array.indexOf(nombreCuentaAhorrosActual);
                if (indexAhorros !== -1) {
                    array.splice(indexAhorros, 1);
                }
                
                array.push(nombre); 
                
                if (indexAhorros !== -1) {
                    array.push(nombreCuentaAhorrosActual);
                }
                
                guardarFn();
                if (tipo === 'cuenta') renderizarCuentas();
                else renderizarCategorias();
                categoriasInputs[tipo].value = ''; 
                actualizarCategoriasYCuentas(); 
                return true;
            } else {
                alert(`${tipo === 'cuenta' ? 'La cuenta' : 'La categoría'} "${nombre}" ya existe.`);
            }
            return false;
        }

        function eliminarGeneral(tipo, nombre) {
            let array;
            let guardarFn;
            let transaccionKey = tipo === 'cuenta' ? 'cuenta' : 'categoria';

            if (tipo === 'cuenta') {
                if (nombre === nombreCuentaAhorrosActual) {
                    alert("La cuenta de ahorro principal no puede ser eliminada.");
                    return false;
                }
                
                array = cuentas;
                guardarFn = guardarCuentas;
            } else {
                array = categorias[tipo];
                guardarFn = guardarConfiguracionLocal;
            }

            const index = array.indexOf(nombre);
            if (index > -1) {
                const transaccionesActivas = todasTransacciones.filter(t => t[transaccionKey] === nombre);
                
                if (transaccionesActivas.length > 0) {
                    alert(`No se puede eliminar porque tiene ${transaccionesActivas.length} transacciones registradas. Elimina las transacciones primero.`);
                    return false;
                }
                
                array.splice(index, 1);
                guardarFn();
                if (tipo === 'cuenta') renderizarCuentas();
                else renderizarCategorias();
                actualizarCategoriasYCuentas(); 
                return true;
            }
            return false;
        }

        function renderizarCuentas() { 
            const listaEl = categoriasListas['cuenta'];
            const countEl = categoriasCounts['cuenta'];
            listaEl.innerHTML = '';
            
            cuentas.forEach((cuenta, index) => {
                const esAhorros = cuenta === nombreCuentaAhorrosActual;
                const listItem = document.createElement('li');
                
                listItem.dataset.nombre = cuenta;
                listItem.dataset.index = index; 

                listItem.className = `flex justify-between items-center p-3 rounded-lg border ${esAhorros ? 'bg-blue-100 border-blue-300 font-semibold' : 'bg-gray-50 draggable-item'}`;
                
                listItem.innerHTML = `
                    <span class="text-gray-800" data-cuenta="${cuenta}">${cuenta}</span>
                    <div>
                        ${esAhorros ? 
                            `<button data-nombre="${cuenta}" class="btn-editar-nombre-ahorros text-blue-600 hover:text-blue-800 transition" title="Editar Nombre de Cuenta">
                                <i data-lucide="pencil" class="w-5 h-5 inline-block"></i>
                            </button>`
                            : 
                            `<button data-tipo="cuenta" data-nombre="${cuenta}" class="btn-eliminar-general text-red-400 hover:text-red-600 transition" title="Eliminar Cuenta">
                                <i data-lucide="x-circle" class="w-5 h-5 inline-block"></i>
                            </button>`
                        }
                    </div>
                `;
                listaEl.appendChild(listItem);
            });

            countEl.textContent = `(${cuentas.length} cuentas)`;
            try { createIcons({ icons: window.lucideIcons }); } catch(e) {}
            
            addDragDropListeners(listaEl);
        }
        
        function renderizarCategorias() {
            Object.keys(categorias).forEach(tipo => {
                const listaEl = categoriasListas[tipo];
                const countEl = categoriasCounts[tipo];
                listaEl.innerHTML = '';
                categorias[tipo].forEach(categoria => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg border';
                    listItem.innerHTML = `
                        <span class="text-gray-800">${categoria}</span>
                        <button data-tipo="${tipo}" data-nombre="${categoria}" class="btn-eliminar-general text-red-400 hover:text-red-600 transition" title="Eliminar Categoría">
                            <i data-lucide="x-circle" class="w-5 h-5 inline-block"></i>
                        </button>
                    `;
                    listaEl.appendChild(listItem);
                });
                
                countEl.textContent = `(${categorias[tipo].length} categorías)`;
            });
            try { createIcons({ icons: window.lucideIcons }); } catch(e) {}
        }


        // --- DRAG & DROP LOGIC ---
        let dragSrcEl = null;

        function handleDragStart(e) {
            if (e.target.closest('li').dataset.nombre === nombreCuentaAhorrosActual) {
                e.preventDefault(); 
                return;
            } 
            dragSrcEl = e.target.closest('li');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', dragSrcEl.outerHTML);
            dragSrcEl.classList.add('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault(); 
            }
            const targetItem = e.target.closest('li');
            if (targetItem && targetItem.dataset.nombre !== nombreCuentaAhorrosActual) {
                 e.dataTransfer.dropEffect = 'move';
            }
            return false;
        }

        function handleDragEnter(e) {
            const targetItem = e.target.closest('li');
            if (targetItem && targetItem.dataset.nombre !== nombreCuentaAhorrosActual) {
                 targetItem.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const targetItem = e.target.closest('li');
            if (targetItem) {
                targetItem.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            
            const targetEl = e.target.closest('li');

            if (dragSrcEl !== targetEl && targetEl && dragSrcEl) {
                if (targetEl.dataset.nombre !== nombreCuentaAhorrosActual) {
                    targetEl.parentNode.insertBefore(dragSrcEl, targetEl.nextSibling);
                    updateAccountOrder();
                } else if (targetEl.dataset.nombre === nombreCuentaAhorrosActual) {
                    targetEl.parentNode.insertBefore(dragSrcEl, targetEl);
                    updateAccountOrder();
                }
            }
            
            if (targetEl) {
                targetEl.classList.remove('drag-over');
            }
            return false;
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('#lista-cuenta li').forEach(item => item.classList.remove('drag-over'));
        }
        
        function updateAccountOrder() {
            const listaEl = document.getElementById('lista-cuenta');
            const newOrder = [];
            
            listaEl.querySelectorAll('li').forEach(item => {
                 const nombre = item.dataset.nombre;
                 if (nombre) {
                     newOrder.push(nombre);
                 }
            });
            
            cuentas = newOrder;
            guardarCuentas();
        }

        function addDragDropListeners(list) {
            list.querySelectorAll('li').forEach(item => {
                if (item.dataset.nombre !== nombreCuentaAhorrosActual) {
                    item.setAttribute('draggable', 'true');
                    item.addEventListener('dragstart', handleDragStart, false);
                    item.addEventListener('dragenter', handleDragEnter, false);
                    item.addEventListener('dragover', handleDragOver, false);
                    item.addEventListener('dragleave', handleDragLeave, false);
                    item.addEventListener('drop', handleDrop, false);
                    item.addEventListener('dragend', handleDragEnd, false);
                }
            });
        }
        
        // --- Eventos de Administración de Datos (Asegurados) ---

        // 1. Botones de AGREGAR (Cuentas/Categorías)
        btnAgregarGeneral.forEach(button => {
            button.addEventListener('click', () => {
                const tipo = button.dataset.tipo;
                const input = categoriasInputs[tipo];
                agregarGeneral(tipo, input.value);
            });
        });

        // 2. Botones de ELIMINAR (X) y EDICIÓN de cuentas/categorías
        document.getElementById('seccion-categorias').addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.btn-eliminar-general');
            const editBtn = e.target.closest('.btn-editar-nombre-ahorros');

            if (deleteButton) {
                const nombre = deleteButton.dataset.nombre;
                const tipo = deleteButton.dataset.tipo;
                eliminarGeneral(tipo, nombre);
            }
            
            if (editBtn) {
                const nombreAnterior = editBtn.dataset.nombre;
                const nuevoNombre = prompt(`Introduce el nuevo nombre para la cuenta de ahorros:`, nombreAnterior);
                
                if (nuevoNombre && nuevoNombre.trim() !== '' && nuevoNombre.trim() !== nombreAnterior) {
                    const nuevoNombreLimpio = nuevoNombre.trim();

                    // 1. Reemplazar el nombre anterior por el nuevo en el array 'cuentas'
                    const index = cuentas.indexOf(nombreAnterior);
                    if (index !== -1) {
                        cuentas[index] = nuevoNombreLimpio;
                    }
                    
                    // 2. Actualizar todas las transacciones (histórico)
                    todasTransacciones.forEach(t => {
                        if (t.cuenta === nombreAnterior) {
                            t.cuenta = nuevoNombreLimpio;
                        }
                    });
                    
                    // 3. Guardar el nuevo nombre visible y el array de cuentas
                    guardarNombreCuentaAhorros(nuevoNombreLimpio); 
                    guardarCuentas();
                    guardarConfiguracionLocal(); // Guarda todo en localStorage
                    
                    // 4. Renderizar y recalcular
                    renderizarCuentas(); 
                    filtrarYRenderizar(); 
                }
            }
        });


        // --- 8. INICIO DE LA APLICACIÓN ---
        
        inicializarPestanas(); 
        inicializarSelectorMes();
        // Inicializa los selectores con las cuentas/categorías
        actualizarCategoriasYCuentas(); 
        // Carga los datos de Supabase y renderiza el resumen
        cargarDatosDesdeSupabase(); 

        try {
            createIcons({ icons: window.lucideIcons });
        } catch(e) {
             console.warn("Error al cargar iconos principales. La aplicación funcionará, pero los iconos pueden faltar.", e.message);
        }
    </script>
