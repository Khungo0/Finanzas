<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas Personales (Supabase Cloud)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
        .category-bar-container { height: 1.5rem; border-radius: 0.5rem; overflow: hidden; display: flex; }
        .category-bar-segment { height: 100%; }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="mb-8 text-center">
        <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight">Finanzas Personales (Supabase Cloud)</h1>
        <p id="auth-status" class="text-sm text-green-600 mt-1">Conectado a la nube. Los datos se guardan remotamente. ☁️</p>
    </header>

    <div class="max-w-7xl mx-auto mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="md:col-span-1 flex justify-between items-center bg-white p-4 rounded-xl card-shadow">
            <label for="selector-mes" class="text-lg font-semibold text-gray-700">Mes Actual:</label>
            <select id="selector-mes" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 w-40">
                </select>
        </div>
        <div class="md:col-span-2 hidden">
            <button id="btn-analisis-gemini" class="w-full py-3 px-4 bg-purple-600 text-white font-semibold rounded-xl shadow-md transition duration-150 flex justify-center items-center" disabled>
                <span class="mr-2">✨ Análisis Gemini (INACTIVO)</span>
            </button>
        </div>
    </div>
    
    <main class="max-w-7xl mx-auto">
        
        <section id="resumen-dashboard" class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl card-shadow border-t-4 border-gray-500">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-500">Saldo Inicial</h2>
                    <i data-lucide="home" class="w-6 h-6 text-gray-500"></i>
                </div>
                <p id="saldo-inicial" class="text-3xl font-bold text-gray-800 mt-2">$0.00</p>
                <p class="text-sm text-gray-400 mt-1">Saldo del mes anterior</p>
            </div>

            <div class="bg-white p-6 rounded-xl card-shadow border-t-4 border-green-500">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-500">Ingresos</h2>
                    <i data-lucide="arrow-up-circle" class="w-6 h-6 text-green-500"></i>
                </div>
                <p id="ingresos-totales" class="text-3xl font-bold text-gray-800 mt-2">$0.00</p>
                <p class="text-sm text-gray-400 mt-1">Total de entradas del mes</p>
            </div>

            <div class="bg-white p-6 rounded-xl card-shadow border-t-4 border-red-500">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-500">Gastos</h2>
                    <i data-lucide="arrow-down-circle" class="w-6 h-6 text-red-500"></i>
                </div>
                <p id="gastos-totales" class="text-3xl font-bold text-gray-800 mt-2">$0.00</p>
                <p class="text-sm text-gray-400 mt-1">Total de salidas del mes</p>
            </div>

            <div class="bg-white p-6 rounded-xl card-shadow border-t-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-500">Saldo Final</h2>
                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-500"></i>
                </div>
                <p id="balance-neto" class="text-3xl font-bold mt-2 text-blue-600">$0.00</p>
                <p class="text-sm text-gray-400 mt-1">Saldo Inicial + Ingresos - Gastos</p>
            </div>

            <div class="bg-white p-6 rounded-xl card-shadow border-t-4 border-emerald-500">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-500">Ahorro Total</h2>
                    <i data-lucide="gem" class="w-6 h-6 text-emerald-500"></i>
                </div>
                <p id="ahorro-acumulado-total" class="text-3xl font-bold text-emerald-600 mt-2">$0.00</p>
                <p class="text-sm text-gray-400 mt-1">Ahorro acumulado histórico</p>
            </div>
        </section>

        <section id="analisis-resultado" class="hidden"></section>

        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            
            <div class="lg:col-span-1 bg-white p-6 rounded-xl card-shadow">
                <h2 class="text-2xl font-bold mb-4 text-gray-700 flex items-center">
                    <i data-lucide="plus-circle" class="w-6 h-6 mr-2 text-indigo-500"></i>
                    Nueva Transacción
                </h2>
                <form id="form-transaccion" class="space-y-4">
                    
                    <div>
                        <label for="tipo" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="tipo" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="ingreso">Ingreso</option>
                            <option value="gasto">Gasto</option>
                            <option value="ahorro">Ahorro</option>
                        </select>
                    </div>

                    <div>
                        <label for="categoria" class="block text-sm font-medium text-gray-700">Categoría</label>
                        <select id="categoria" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                            </select>
                    </div>

                    <div id="ahorro-sugerencia-container" class="space-y-2 hidden"></div>

                    <div>
                        <label for="monto" class="block text-sm font-medium text-gray-700">Monto ($)</label>
                        <input type="number" id="monto" required min="0.01" step="0.01" placeholder="Ej: 500.00" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div>
                        <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripción</label>
                        <input type="text" id="descripcion" required placeholder="Ej: Pago de alquiler" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <div>
                        <label for="fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                        <input type="date" id="fecha" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <button type="submit" class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-md transition duration-150">
                        Guardar Transacción
                    </button>
                    <div id="form-message" class="text-center mt-2 text-sm hidden"></div>
                </form>
            </div>

            <div class="lg:col-span-2 bg-white p-6 rounded-xl card-shadow">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Distribución de Gastos</h2>
                
                <div id="chart-container" class="space-y-4">
                    <div class="mb-6">
                        <p class="text-lg font-medium text-gray-600">Total Gastado vs. Total Fondos (Mensual)</p>
                        <div class="category-bar-container bg-gray-200 mt-2">
                            <div id="gasto-bar-total" class="category-bar-segment transition-all duration-500" style="width: 0%;"></div>
                        </div>
                        <p id="gasto-porcentaje" class="text-right text-sm text-gray-500 mt-1">0% de los fondos disponibles gastados</p>
                    </div>
                    
                    <h3 class="text-xl font-semibold text-gray-700 border-b pb-2">Gastos por Categoría</h3>
                    <div id="gastos-por-categoria" class="space-y-3">
                        <p class="text-gray-500 text-center">No hay gastos registrados aún.</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="bg-white p-6 rounded-xl card-shadow">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Historial de Transacciones del Mes</h2>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="lista-transacciones" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="6" class="p-4 text-center text-gray-500">Cargando transacciones...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-lg p-6 max-w-sm w-full card-shadow">
                <h3 id="modal-title" class="text-lg font-semibold mb-3 text-gray-800">Confirmar Eliminación</h3>
                <p id="modal-body" class="text-gray-600 mb-4">¿Estás seguro de que quieres eliminar esta transacción?</p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel" class="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button id="modal-confirm" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition">Eliminar</button>
                </div>
            </div>
        </div>

    </main>

    <script type="module">
        // --- 1. CONFIGURACIÓN DE SUPABASE Y LIBRERÍAS ---
        import { createIcons, Home, DollarSign, ArrowUpCircle, ArrowDownCircle, PlusCircle, Trash2, Gem } from 'https://cdn.jsdelivr.net/npm/lucide@latest/dist/esm/lucide.js';
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // TUS CREDENCIALES DE SUPABASE (ACTUALIZADAS CON TUS DATOS)
        const SUPABASE_URL = 'https://agbkeubwhbzjyrmzzkjd.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnYmtldWJ3aGJ6anlybXp6a2pkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MTA3ODksImV4cCI6MjA3Njk4Njc4OX0.pj3-hUlKcSb3BDuOvhOQD7sMzf5qONQdiLw9nT5MJis'; 
        const TABLA_TRANSACCIONES = 'transacciones';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // --- 2. VARIABLES Y ESTADO ---
        let todasTransacciones = []; 
        let transaccionesMesActual = []; 
        let mesSeleccionado = ''; 
        let resumenMensual = {}; 
        
        const categorias = {
            ingreso: ['Salario', 'Freelance', 'Inversiones', 'Venta', 'Regalo', 'Otro Ingreso'],
            gasto: ['Vivienda', 'Alimentación', 'Transporte', 'Ocio', 'Deudas', 'Servicios', 'Salud', 'Educación', 'Otro Gasto'],
            ahorro: ['Fondo de Emergencia', 'Meta Viaje', 'Meta Casa', 'Inversión Crecimiento']
        };

        // Referencias del DOM
        const tipoSelect = document.getElementById('tipo');
        const categoriaSelect = document.getElementById('categoria');
        const formTransaccion = document.getElementById('form-transaccion');
        const listaTransaccionesEl = document.getElementById('lista-transacciones');
        const gastosPorCategoriaEl = document.getElementById('gastos-por-categoria');
        const gastoBarTotalEl = document.getElementById('gasto-bar-total');
        const gastoPorcentajeEl = document.getElementById('gasto-porcentaje');
        const formMessageEl = document.getElementById('form-message');
        const modalContainer = document.getElementById('modal-container');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');
        const fechaInput = document.getElementById('fecha');
        const selectorMesEl = document.getElementById('selector-mes');
        
        // --- 3. LÓGICA DE UTILIDAD ---
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('es-US', { style: 'currency', currency: 'USD' }).format(amount);
        };
        
        // --- 4. FUNCIONES CRUD CON SUPABASE ---

        async function cargarDatosDesdeSupabase() {
            // Se usa .select('*') para traer todas las columnas
            const { data, error } = await supabase
                .from(TABLA_TRANSACCIONES)
                .select('*'); 
            
            if (error) {
                console.error("Error al cargar datos de Supabase:", error);
                document.getElementById('lista-transacciones').innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Error al cargar datos: ${error.message}. Verifica las políticas RLS.</td></tr>`;
                todasTransacciones = [];
            } else {
                // Mapear y asignar los datos a la variable global
                todasTransacciones = data.map(t => ({
                    ...t,
                    // Parsear el monto a número flotante
                    monto: parseFloat(t.monto), 
                    // Obtener YYYY-MM para filtrar
                    mesAnio: t.fecha.substring(0, 7) 
                }));
            }
            
            filtrarYRenderizar();
        }

        async function guardarTransaccion(transaccion) {
            
            const { data, error } = await supabase
                .from(TABLA_TRANSACCIONES)
                .insert([{
                    tipo: transaccion.tipo,
                    categoria: transaccion.categoria,
                    descripcion: transaccion.descripcion,
                    monto: parseFloat(transaccion.monto),
                    fecha: transaccion.fecha,
                }]);
                
            if (error) {
                console.error("Error al guardar en Supabase:", error);
                formMessageEl.textContent = `Error al guardar: ${error.message}`;
                formMessageEl.classList.remove('hidden', 'text-green-500');
                formMessageEl.classList.add('text-red-500');
            } else {
                // Recargar todos los datos para actualizar la UI
                await cargarDatosDesdeSupabase(); 

                formMessageEl.textContent = "¡Transacción guardada con éxito en la nube!";
                formMessageEl.classList.remove('hidden', 'text-red-500');
                formMessageEl.classList.add('text-green-500');
                formTransaccion.reset();
                fechaInput.value = new Date().toISOString().substring(0, 10);
                setTimeout(() => formMessageEl.classList.add('hidden'), 3000);
            }
        }

        async function eliminarTransaccion(id) {
            
            const { error } = await supabase
                .from(TABLA_TRANSACCIONES)
                .delete()
                .eq('id', id); // Condición para eliminar el registro con ese 'id'

            if (error) {
                console.error("Error al eliminar en Supabase:", error);
            } else {
                // Recarga los datos para actualizar la interfaz
                await cargarDatosDesdeSupabase();
            }
        }
        
        // --- 5. LÓGICA DE FILTRADO Y CÁLCULO (Mantenida) ---

        function filtrarYRenderizar() {
             // 1. Filtrar las transacciones del mes seleccionado
            transaccionesMesActual = todasTransacciones
                .filter(t => t.mesAnio === mesSeleccionado)
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                
            // 2. Calcular el resumen y el saldo inicial
            resumenMensual = calcularResumenMensual();

            // 3. Renderizar la UI
            const { ingresosTotales, gastosTotales, balanceNeto, saldoInicial, gastosPorCategoria, ahorroAcumulado } = resumenMensual;
            renderizarDashboard(ingresosTotales, gastosTotales, balanceNeto, saldoInicial, gastosPorCategoria, ahorroAcumulado);
            renderizarListaTransacciones();
        }

        function calcularResumenMensual() {
            let ingresosMes = 0;
            let gastosMes = 0;
            let gastosPorCategoria = {};
            let ahorroAcumulado = 0;
            let saldoInicial = 0;
            
            todasTransacciones.forEach(t => {
                const monto = t.monto;

                if (t.tipo === 'ahorro') {
                    ahorroAcumulado += monto;
                }

                if (t.mesAnio < mesSeleccionado) {
                    if (t.tipo === 'ingreso') {
                        saldoInicial += monto;
                    } else if (t.tipo === 'gasto' || t.tipo === 'ahorro') {
                        saldoInicial -= monto;
                    }
                } else if (t.mesAnio === mesSeleccionado) {
                    if (t.tipo === 'ingreso') {
                        ingresosMes += monto;
                    } else if (t.tipo === 'gasto' || t.tipo === 'ahorro') {
                        gastosMes += monto; 

                        if (t.tipo === 'gasto') {
                            gastosPorCategoria[t.categoria] = (gastosPorCategoria[t.categoria] || 0) + monto;
                        }
                    }
                }
            });
            const balanceNeto = saldoInicial + ingresosMes - gastosMes;

            return { ingresosTotales: ingresosMes, gastosTotales: gastosMes, balanceNeto: balanceNeto, saldoInicial: saldoInicial, gastosPorCategoria: gastosPorCategoria, ahorroAcumulado: ahorroAcumulado };
        }

        // --- 6. LÓGICA DE RENDERIZACIÓN DE LA UI (Mantenida) ---

        function inicializarSelectorMes() {
            const hoy = new Date();
            const year = hoy.getFullYear();
            const month = hoy.getMonth();
            
            let opcionesHTML = '';
            const mesesNombre = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

            for (let i = 0; i <= 5; i++) {
                const fecha = new Date(year, month + i, 1);
                const valor = `${fecha.getFullYear()}-${(fecha.getMonth() + 1).toString().padStart(2, '0')}`;
                const nombre = `${mesesNombre[fecha.getMonth()]} ${fecha.getFullYear()}`;
                opcionesHTML += `<option value="${valor}">${nombre}</option>`;
            }

            selectorMesEl.innerHTML = opcionesHTML;
            mesSeleccionado = `${year}-${(month + 1).toString().padStart(2, '0')}`;
            selectorMesEl.value = mesSeleccionado;
            fechaInput.value = hoy.toISOString().substring(0, 10);

            selectorMesEl.addEventListener('change', (e) => {
                mesSeleccionado = e.target.value;
                filtrarYRenderizar();
            });
        }

        function renderizarDashboard(ingresosTotales, gastosTotales, balanceNeto, saldoInicial, gastosPorCategoria, ahorroAcumulado) {
            document.getElementById('saldo-inicial').textContent = formatCurrency(saldoInicial);
            document.getElementById('ingresos-totales').textContent = formatCurrency(ingresosTotales);
            document.getElementById('gastos-totales').textContent = formatCurrency(gastosTotales);
            document.getElementById('ahorro-acumulado-total').textContent = formatCurrency(ahorroAcumulado); 
            
            const saldoInicialEl = document.getElementById('saldo-inicial');
            saldoInicialEl.classList.remove('text-green-600', 'text-red-600', 'text-gray-800');
            if (saldoInicial > 0) saldoInicialEl.classList.add('text-green-600'); 
            else if (saldoInicial < 0) saldoInicialEl.classList.add('text-red-600'); 
            else saldoInicialEl.classList.add('text-gray-800');

            const balanceEl = document.getElementById('balance-neto');
            balanceEl.textContent = formatCurrency(balanceNeto);
            balanceEl.classList.remove('text-green-600', 'text-red-600', 'text-blue-600');
            if (balanceNeto > 0) balanceEl.classList.add('text-green-600'); 
            else if (balanceNeto < 0) balanceEl.classList.add('text-red-600'); 
            else balanceEl.classList.add('text-blue-600');
            
            let totalDisponibleParaGasto = saldoInicial + ingresosTotales;
            let porcentajeGasto = 0;
            if (totalDisponibleParaGasto > 0) porcentajeGasto = (gastosTotales / totalDisponibleParaGasto) * 100;
            porcentajeGasto = Math.min(porcentajeGasto, 100); 

            gastoBarTotalEl.style.width = `${porcentajeGasto}%`;
            gastoPorcentajeEl.textContent = `${porcentajeGasto.toFixed(1)}% de los fondos disponibles gastados`;
            gastoBarTotalEl.classList.remove('bg-red-500', 'bg-yellow-500', 'bg-indigo-500');
            if (porcentajeGasto >= 80) gastoBarTotalEl.classList.add('bg-red-500'); 
            else if (porcentajeGasto > 50) gastoBarTotalEl.classList.add('bg-yellow-500'); 
            else gastoBarTotalEl.classList.add('bg-indigo-500');

            renderizarGastosPorCategoria(gastosPorCategoria, gastosTotales);
        }

        function renderizarGastosPorCategoria(gastosPorCategoria, gastosTotales) {
            gastosPorCategoriaEl.innerHTML = '';
            if (gastosTotales === 0) {
                gastosPorCategoriaEl.innerHTML = '<p class="text-gray-500 text-center py-4">No hay gastos reales (sin incluir ahorro) registrados en este mes.</p>';
                return;
            }
            const colores = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#0ea5e9', '#6366f1', '#a855f7', '#ec4899', '#f43f5e'];
            let colorIndex = 0;
            const categoriasOrdenadas = Object.entries(gastosPorCategoria).sort(([, a], [, b]) => b - a);

            categoriasOrdenadas.forEach(([categoria, monto]) => {
                const porcentaje = (monto / gastosTotales) * 100;
                const color = colores[colorIndex % colores.length];
                colorIndex++;
                const html = `
                    <div>
                        <div class="flex justify-between text-sm font-medium">
                            <span class="text-gray-700">${categoria}</span>
                            <span class="text-gray-600">${formatCurrency(monto)} (${porcentaje.toFixed(1)}%)</span>
                        </div>
                        <div class="category-bar-container bg-gray-200 mt-1">
                            <div class="category-bar-segment transition-all duration-500" style="width: ${porcentaje}%; background-color: ${color};"></div>
                        </div>
                    </div>
                `;
                gastosPorCategoriaEl.insertAdjacentHTML('beforeend', html);
            });
        }

        function renderizarListaTransacciones() {
            if (transaccionesMesActual.length === 0) {
                listaTransaccionesEl.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">No hay transacciones registradas para este mes.</td></tr>`;
                return;
            }

            listaTransaccionesEl.innerHTML = transaccionesMesActual.map(t => {
                const esIngreso = t.tipo === 'ingreso';
                const esAhorro = t.tipo === 'ahorro';
                const montoClase = esIngreso ? 'text-green-600 font-semibold' : esAhorro ? 'text-blue-600 font-semibold' : 'text-red-600 font-semibold';
                const tipoClase = esIngreso ? 'bg-green-100 text-green-800' : esAhorro ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800';
                const tipoTexto = esIngreso ? 'INGRESO' : esAhorro ? 'AHORRO' : 'GASTO';

                return `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.fecha}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${tipoClase}">${tipoTexto}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.categoria}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${t.descripcion}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm ${montoClase}">${formatCurrency(t.monto)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${t.id}" class="btn-eliminar text-red-500 hover:text-red-700 transition" title="Eliminar Transacción">
                                <i data-lucide="trash-2" class="w-5 h-5 inline-block"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            createIcons({ icons: { Trash2 } }); 
        }

        // --- 7. MANEJO DE EVENTOS ---

        function actualizarCategorias() {
            const tipo = tipoSelect.value;
            const cats = categorias[tipo] || [];
            categoriaSelect.innerHTML = cats.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        tipoSelect.addEventListener('change', actualizarCategorias);
        
        formTransaccion.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const fechaTransaccion = document.getElementById('fecha').value;
            const mesAnioTransaccion = fechaTransaccion.substring(0, 7);

            if (mesAnioTransaccion !== mesSeleccionado) {
                 formMessageEl.textContent = `Advertencia: La transacción es del mes ${mesAnioTransaccion}, pero estás viendo ${mesSeleccionado}. Se guardará.`;
                 formMessageEl.classList.remove('hidden', 'text-green-500');
                 formMessageEl.classList.add('text-red-500');
                 setTimeout(() => formMessageEl.classList.add('hidden'), 5000);
            }

            const transaccion = {
                tipo: tipoSelect.value,
                categoria: categoriaSelect.value,
                monto: parseFloat(document.getElementById('monto').value),
                descripcion: document.getElementById('descripcion').value.trim(),
                fecha: fechaTransaccion,
            };

            if (transaccion.descripcion && transaccion.monto > 0) {
                guardarTransaccion(transaccion);
            } else {
                formMessageEl.textContent = "Por favor, complete todos los campos correctamente.";
                formMessageEl.classList.remove('hidden', 'text-green-500');
                formMessageEl.classList.add('text-red-500');
            }
        });

        listaTransaccionesEl.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.btn-eliminar');
            if (deleteButton) {
                const id = deleteButton.dataset.id;
                mostrarModalConfirmacion(id);
            }
        });

        let idAeliminar = null;
        function mostrarModalConfirmacion(id) {
            idAeliminar = id;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
        }

        modalCancel.addEventListener('click', () => {
            modalContainer.classList.remove('flex');
            modalContainer.classList.add('hidden');
            idAeliminar = null;
        });

        modalConfirm.addEventListener('click', () => {
            if (idAeliminar) {
                eliminarTransaccion(idAeliminar);
            }
            modalContainer.classList.remove('flex');
            modalContainer.classList.add('hidden');
            idAeliminar = null;
        });

        // --- 8. INICIO DE LA APLICACIÓN ---
        
        inicializarSelectorMes();
        actualizarCategorias();
        cargarDatosDesdeSupabase(); 

        createIcons({ icons: { Home, DollarSign, ArrowUpCircle, ArrowDownCircle, PlusCircle, Trash2, Gem } });
    </script>
</body>
</html>
