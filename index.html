<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas 50/30/20 | Transacciones Globales</title>
    
    <link rel="icon" type="image/png" href="mi-icono.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Base Styles */
        body {    
            font-family: 'Inter', sans-serif;    
            background-color: #f4f7f9;    
            padding: 20px;    
            color: #1e293b;
            padding-bottom: 100px; /* Espacio para el FAB */
        }
        main {    
            max-width: 1280px; 
            margin: 0 auto;    
        }

        /* Card and Shadow */
        .card-shadow {    
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);    
            border: 1px solid #e2e8f0;    
            background-color: white;    
            padding: 24px;    
            border-radius: 12px;
        }

        /* Grid Layouts */
        .grid-5-gap {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Responsive */
            gap: 24px;
        }
        .grid-cols-3-dashboard {
            display: grid;
            grid-template-columns: repeat(1, 1fr); /* Default 1 columna en m贸vil */
            gap: 24px;
        }
        @media (min-width: 1024px) { /* En pantallas grandes (lg) */
            .grid-cols-3-dashboard {
                grid-template-columns: 1.5fr 1.5fr 1fr;
            }
        }
        
        /* --- NUEVO: Grid Layout Principal (Lado a Lado) --- */
        .grid-layout-main {
            display: grid;
            grid-template-columns: 1fr; /* 1 columna en m贸vil */
            gap: 24px;
            align-items: start; /* Para que las tarjetas se alineen arriba */
        }
        @media (min-width: 1024px) {
             .grid-layout-main {
                /* 2 columnas en desktop: Resumen (1fr) e Historial (1.5fr) */
                grid-template-columns: 1fr 1.5fr; 
            }
        }
        
        .grid-cols-4-gap-admin {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
        }

        /* Typography and Headings */
        h1 { font-size: 2.25rem; font-weight: 800; color: #1e293b; text-align: center; margin-bottom: 24px; }
        h2 { font-size: 1.5rem; font-weight: 700; color: #475569; margin-bottom: 16px; display: flex; align-items: center; }
        h3 { font-size: 1.125rem; font-weight: 600; color: #475569; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; margin-bottom: 16px; }
        p { margin-top: 4px; }

        /* Dashboard Cards */
        .dashboard-card-title { font-size: 1.125rem; color: #64748b; }
        .dashboard-card-value { font-size: 2rem; font-weight: 700; margin-top: 4px; }
        .dashboard-card-icon {
            width: 36px;
            height: 36px;
            stroke-width: 2;
        }

        .border-green-500 { border-left: 4px solid #22c55e; }
        .border-red-500 { border-left: 4px solid #ef4444; }
        .border-gray-500 { border-left: 4px solid #64748b; }
        .border-indigo-500 { border-left: 4px solid #6366f1; }
        .border-emerald-500 { border-left: 4px solid #10b981; }    
        .border-blue-500 { border-left: 4px solid #3b82f6; }

        .text-green-600 { color: #10b981; }
        .text-red-600 { color: #ef4444; }
        .text-indigo-700 { color: #4f46e5; }
        .text-gray-800 { color: #1e293b; }
        .text-emerald-600 { color: #059669; }
        .text-blue-600 { color: #2563eb; }
        
        /* Tabs */
        .tab-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px 0;
            margin-right: 24px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: color 0.15s, border-color 0.15s;
            border-bottom: 2px solid transparent;
            color: #64748b;
        }
        .tab-button-active {
            border-bottom-color: #4f46e5;
            color: #4f46e5;
        }
        
        .text-red-700 { color: #b91c1c; }
        .text-orange-700 { color: #c2410c; }
        .text-emerald-700 { color: #059669; }

        /* --- NUEVO: Estilos de Barra de Progreso --- */
        .progress-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .progress-labels {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }
        .progress-title { font-weight: 700; font-size: 1.125rem; }
        .progress-amount { font-weight: 600; font-size: 1rem; }
        .progress-track {
            width: 100%;
            height: 12px;
            background-color: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.3s ease-out, background-color 0.3s;
        }
        .progress-fill-50 { background-color: #ef4444; } /* Rojo */
        .progress-fill-30 { background-color: #f97316; } /* Naranja */
        .progress-fill-20 { background-color: #10b981; } /* Verde */
        
        .progress-fill-danger { background-color: #dc2626; } /* Rojo Fuerte (Alerta) */

        .progress-footer {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #64748b;
        }
        .progress-remaining-danger {
            color: #dc2626;
            font-weight: 600;
        }
        .progress-remaining-success {
            color: #059669;
            font-weight: 600;
        }

        /* Form Controls */
        select, input[type="text"], input[type="number"], input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-top: 4px;
        }
        button[type="submit"], .btn-agregar-general {
            padding: 10px;
            background-color: #4f46e5;
            color: white;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        button:disabled {
            background-color: #a5b4fc; /* Indigo-300 */
            cursor: not-allowed;
        }
        
        /* Table Styles */
        table { width: 100%; border-collapse: collapse; }
        thead { background-color: #f8fafc; }
        th, td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: left; font-size: 0.875rem; }
        th { font-weight: 600; text-transform: uppercase; color: #64748b; }
        
        /* Icons and Buttons */
        .btn-eliminar-general, .btn-editar { background: none; border: none; cursor: pointer; margin-left: 8px; }
        .text-red-400 { color: #f87171; }
        .text-indigo-500 { color: #6366f1; }

        .hidden { display: none; }

        /* --- NUEVO: Estilos del Bot贸n Flotante (FAB) --- */
        #fab-nueva-transaccion {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background-color: #4f46e5;
            color: white;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            z-index: 40;
        }
        #fab-nueva-transaccion:hover {
            background-color: #4338ca;
            transform: scale(1.05);
        }

        /* --- NUEVO: Estilos del Modal del Formulario --- */
        #modal-nueva-transaccion {
            position: fixed; 
            inset: 0; 
            background-color: rgba(30, 41, 59, 0.75); 
            z-index: 50; 
            display: none;
            align-items: center; 
            justify-content: center; 
            padding: 16px;
        }
        #modal-nueva-transaccion-content {
            background-color: white; 
            border-radius: 8px; 
            padding: 24px; 
            max-width: 576px;
            width: 100%; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* --- NUEVO: Estilos Filtros y Paginaci贸n --- */
        .filter-controls {
            display: flex;
            flex-wrap: wrap; /* Para m贸viles */
            gap: 8px;
            margin-bottom: 24px;
        }
        .filter-btn {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            color: #64748b;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: background-color 0.15s, color 0.15s;
        }
        .filter-btn:hover {
            background-color: #f1f5f9;
        }
        .filter-btn.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        #pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-top: 24px;
        }
        #pagination-controls button {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            color: #64748b;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
        }
        #pagination-controls button:disabled {
            background-color: #f8fafc;
            color: #cbd5e1;
            cursor: not-allowed;
        }
        #page-info {
            font-size: 0.875rem;
            font-weight: 600;
            color: #475569;
        }

    </style>
</head>
<body class="p-4 md:p-10">

    <header class="mb-10 text-center">
        <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight"> Finanzas 50/30/20 (Global)</h1>
        <p id="auth-status" class="text-sm text-green-600 mt-1">Conectado a la nube. Datos en Supabase. 锔</p>
    </header>

    <div class="max-w-6xl mx-auto mb-8 flex justify-between items-center card-shadow" style="padding: 15px;">
        <label for="selector-mes" class="text-lg font-semibold text-gray-700">Mes de An谩lisis:</label>
        <select id="selector-mes" style="padding: 8px; border-radius: 6px; border: 1px solid #ccc; width: 160px;">
            </select>
    </div>
    
    <main class="max-w-6xl mx-auto">
        
        <section id="tabs-container" class="mb-8">
            <div style="border-bottom: 1px solid #e2e8f0;">
                <nav class="flex" aria-label="Tabs">
                    <button id="tab-resumen" class="tab-button tab-button-active" data-target="seccion-resumen">
                        Dashboard y Transacciones
                    </button>
                    <button id="tab-clasificacion" class="tab-button" data-target="seccion-clasificacion-503020">
                        Clasificaci贸n 50/30/20
                    </button>
                </nav>
            </div>
        </section>

        <div id="seccion-resumen" class="tab-content">
            
            <section id="resumen-dashboard" class="grid-5-gap mb-10">
                <div class="card-shadow border-gray-500">
                    <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 16px;">
                        <div>
                            <h2 class="dashboard-card-title">Saldo Inicial</h2>
                            <p id="saldo-inicial" class="dashboard-card-value text-gray-800">$0.00</p>
                        </div>
                        <i data-lucide="landmark" class="dashboard-card-icon text-gray-400"></i>
                    </div>
                </div>

                <div class="card-shadow border-green-500">
                    <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 16px;">
                        <div>
                            <h2 class="dashboard-card-title">Ingresos Totales</h2>
                            <p id="ingresos-totales" class="dashboard-card-value text-green-600">$0.00</p>
                        </div>
                        <i data-lucide="arrow-up-circle" class="dashboard-card-icon text-green-400"></i>
                    </div>
                </div>
                
                <div class="card-shadow border-red-500">
                     <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 16px;">
                        <div>
                            <h2 class="dashboard-card-title">Gastos del Mes (50/30)</h2>
                            <p id="gastos-mes" class="dashboard-card-value text-red-600">$0.00</p>
                        </div>
                        <i data-lucide="arrow-down-circle" class="dashboard-card-icon text-red-400"></i>
                    </div>
                </div>

                <div class="card-shadow border-blue-500">
                     <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 16px;">
                        <div>
                            <h2 class="dashboard-card-title">Ahorro del Mes (20%)</h2>
                            <p id="ahorro-mes" class="dashboard-card-value text-blue-600">$0.00</p>
                        </div>
                        <i data-lucide="piggy-bank" class="dashboard-card-icon text-blue-400"></i>
                    </div>
                </div>

                <div class="card-shadow border-indigo-500">
                     <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 16px;">
                        <div>
                            <h2 class="dashboard-card-title">Saldo Final (Global)</h2>
                            <p id="balance-neto" class="dashboard-card-value text-indigo-700">$0.00</p>
                        </div>
                         <i data-lucide="scale" class="dashboard-card-icon text-indigo-400"></i>
                    </div>
                </div>
                
                <div class="card-shadow border-emerald-500">
                    <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 16px;">
                        <div>
                            <h2 class="dashboard-card-title">Ahorro Acumulado</h2>
                            <p id="ahorro-acumulado-total" class="dashboard-card-value text-emerald-600">$0.00</p>
                        </div>
                        <i data-lucide="gem" class="dashboard-card-icon text-emerald-400"></i>
                    </div>
                </div>
            </section>

            <div class="grid-layout-main">
                
                <section class="card-shadow space-y-6">
                    <h2 style="margin-bottom: 24px;">
                        <i data-lucide="target" style="width: 24px; height: 24px; margin-right: 8px; color: #ec4899;"></i>
                        Resumen 50/30/20
                    </h2>
                    
                    <div style="display: flex; flex-direction: column; gap: 24px;">
                        
                        <div style="text-align: center; border-bottom: 1px solid #e2e8f0; padding-bottom: 16px;">
                            <p style="font-size: 1rem; font-weight: 600; color: #475569;">Ingreso Total del Mes (Base)</p>
                            <p id="ingreso-neto-503020" style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">$0.00</p>
                        </div>

                        <div class="progress-section">
                            <div class="progress-labels">
                                <span class="progress-title text-red-700">50% Necesidades</span>
                                <span id="gasto-50" class="progress-amount text-red-700">$0.00</span>
                            </div>
                            <div class="progress-track">
                                <div id="progress-fill-50" class="progress-fill progress-fill-50" style="width: 0%;"></div>
                            </div>
                            <div class="progress-footer">
                                <span>Objetivo: <span id="objetivo-50">$0.00</span></span>
                                <span id="restante-50-label">Restante: <span id="restante-50">$0.00</span></span>
                            </div>
                        </div>

                        <div class="progress-section">
                            <div class="progress-labels">
                                <span class="progress-title text-orange-700">30% Deseos</span>
                                <span id="gasto-30" class="progress-amount text-orange-700">$0.00</span>
                            </div>
                            <div class="progress-track">
                                <div id="progress-fill-30" class="progress-fill progress-fill-30" style="width: 0%;"></div>
                            </div>
                            <div class="progress-footer">
                                <span>Objetivo: <span id="objetivo-30">$0.00</span></span>
                                <span id="restante-30-label">Restante: <span id="restante-30">$0.00</span></span>
                            </div>
                        </div>

                        <div class="progress-section">
                            <div class="progress-labels">
                                <span class="progress-title text-emerald-700">20% Ahorro</span>
                                <span id="gasto-20" class="progress-amount text-emerald-700">$0.00</span>
                            </div>
                            <div class="progress-track">
                                <div id="progress-fill-20" class="progress-fill progress-fill-20" style="width: 0%;"></div>
                            </div>
                            <div class="progress-footer">
                                <span>Objetivo: <span id="objetivo-20">$0.00</span></span>
                                <span id="restante-20-label">Faltante: <span id="restante-20">$0.00</span></span>
                            </div>
                        </div>

                    </div>
                </section>

                <section class="card-shadow">
                    <h2>Historial de Transacciones del Mes</h2>
                    
                    <div class="filter-controls">
                        <button class="filter-btn active" data-tipo="todos">Todos</button>
                        <button class="filter-btn" data-tipo="ingreso">Ingresos</button>
                        <button class="filter-btn" data-tipo="gasto">Gastos</button>
                        <button class="filter-btn" data-tipo="ahorro">Ahorros</button>
                    </div>

                    <div style="overflow-x: auto;">
                        <table style="min-width: 100%;">
                            <thead>
                                <tr>
                                    <th style="width: 10%;">Fecha</th>
                                    <th style="width: 12%;">Tipo</th>
                                    <th style="width: 15%;">Categor铆a</th>
                                    <th style="width: 47%;">Descripci贸n</th>
                                    <th style="width: 10%; text-align: right;">Monto</th>
                                    <th style="width: 6%; text-align: right;">Acci贸n</th>
                                </tr>
                            </thead>
                            <tbody id="lista-transacciones">
                                </tbody>
                        </table>
                    </div>

                    <div id="pagination-controls" style="display: none;"> <button id="prev-page" disabled>&lt; Anterior</button>
                        <span id="page-info">P谩gina 1 de 1</span>
                        <button id="next-page" disabled>Siguiente &gt;</button>
                    </div>

                </section>
                
            </div> </div>

        <div id="seccion-clasificacion-503020" class="tab-content hidden">
            <div class="card-shadow">
                <h2>
                    <i data-lucide="list-checks" style="width: 24px; height: 24px; margin-right: 8px; color: #6366f1;"></i>
                    Clasificaci贸n y Administraci贸n de Categor铆as
                </h2>
                <p style="color: #64748b; margin-bottom: 24px;">Administra tus **Categor铆as de Ingreso** y clasifica tus **Gastos/Ahorros** directamente en la categor铆a porcentual deseada (50%, 30%, 20%).</p>
                <div class="grid-4-gap">
                    <div style="display: flex; flex-direction: column;">
                        <h3 style="color: #22c55e;">Ingresos (Fuentes) <span id="count-ingreso" style="font-size: 0.875rem; font-weight: 400; color: #64748b;"></span></h3>
                        <ul id="lista-ingreso" style="display: flex; flex-direction: column; gap: 12px;"></ul>
                        <div style="margin-top: 16px;">
                            <input type="text" id="input-ingreso" placeholder="Nueva fuente de Ingreso" style="margin-bottom: 8px;">
                            <button data-tipo="ingreso" class="btn-agregar-general" style="background-color: #22c55e;">Agregar</button>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column;">
                        <h3 style="color: #ef4444;">50% Necesidades <span id="count-gasto-50" style="font-size: 0.875rem; font-weight: 400; color: #64748b;"></span></h3>
                        <ul id="lista-gasto-50" style="display: flex; flex-direction: column; gap: 12px;"></ul>
                        <div style="margin-top: 16px;">
                            <input type="text" id="input-gasto-50" placeholder="Ej: Alimentaci贸n B谩sica" style="margin-bottom: 8px;">
                            <button data-tipo="gasto-50" class="btn-agregar-general" style="background-color: #ef4444;">Agregar al 50%</button>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column;">
                        <h3 style="color: #f97316;">30% Deseos <span id="count-gasto-30" style="font-size: 0.875rem; font-weight: 400; color: #64748b;"></span></h3>
                        <ul id="lista-gasto-30" style="display: flex; flex-direction: column; gap: 12px;"></ul>
                        <div style="margin-top: 16px;">
                            <input type="text" id="input-gasto-30" placeholder="Ej: Comer Fuera/Ocio" style="margin-bottom: 8px;">
                            <button data-tipo="gasto-30" class="btn-agregar-general" style="background-color: #f97316;">Agregar al 30%</button>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column;">
                        <h3 style="color: #3b82f6;">20% Ahorro/Deuda <span id="count-ahorro-20" style="font-size: 0.875rem; font-weight: 400; color: #64748b;"></span></h3>
                        <ul id="lista-ahorro-20" style="display: flex; flex-direction: column; gap: 12px;"></ul>
                        <div style="margin-top: 16px;">
                            <input type="text" id="input-ahorro-20" placeholder="Ej: Fondo de Emergencia" style="margin-bottom: 8px;">
                            <button data-tipo="ahorro-20" class="btn-agregar-general" style="background-color: #3b82f6;">Agregar al 20%</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-container" style="position: fixed; inset: 0; background-color: rgba(30, 41, 59, 0.75); z-index: 50; display: none; align-items: center; justify-content: center; padding: 16px;">
            <div style="background-color: white; border-radius: 8px; padding: 24px; max-width: 384px; width: 100%; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);">
                <h3 id="modal-title" style="font-size: 1.125rem; font-weight: 600; color: #1e293b; margin-bottom: 12px; border-bottom: none;">Confirmar Eliminaci贸n</h3>
                <p id="modal-body" style="color: #475569; margin-bottom: 16px;">驴Est谩s seguro de que quieres eliminar esta transacci贸n?</p>
                <div style="display: flex; justify-content: flex-end; gap: 12px;">
                    <button id="modal-cancel" style="padding: 8px 16px; font-size: 0.875rem; font-weight: 500; color: #475569; background-color: #e2e8f0; border-radius: 6px; transition: background-color 0.15s; cursor: pointer;">Cancelar</button>
                    <button id="modal-confirm" style="padding: 8px 16px; font-size: 0.875rem; font-weight: 500; color: white; background-color: #dc2626; border-radius: 6px; transition: background-color 0.15s; cursor: pointer;">Eliminar</button>
                </div>
            </div>
        </div>

        <div id="modal-container-edicion" style="position: fixed; inset: 0; background-color: rgba(30, 41, 59, 0.75); z-index: 50; display: none; align-items: center; justify-content: center; padding: 16px;">
            <div style="background-color: white; border-radius: 8px; padding: 24px; max-width: 576px; width: 100%; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);">
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #1e293b; margin-bottom: 16px; border-bottom: none;">Editar Transacci贸n</h3>
                <form id="form-edicion" style="display: flex; flex-direction: column; gap: 16px;">
                    <input type="hidden" id="edit-id">
                    <div>
                        <label for="edit-tipo" style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569;">Tipo</label>
                        <select id="edit-tipo" required>
                            <option value="ingreso">Ingreso</option>
                            <option value="gasto">Gasto</option>
                            <option value="ahorro">Ahorro</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-categoria" style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569;">Categor铆a</label>
                        <select id="edit-categoria" required>
                            </select>
                    </div>
                    <div>
                        <label for="edit-monto" style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569;">Monto ($)</label>
                        <input type="number" id="edit-monto" required min="0.01" step="0.01">
                    </div>
                    <div>
                        <label for="edit-descripcion" style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569;">Descripci贸n</label>
                        <input type="text" id="edit-descripcion" required>
                    </div>
                    <div>
                        <label for="edit-fecha" style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569;">Fecha</label>
                        <input type="date" id="edit-fecha" required>
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 12px; padding-top: 16px;">
                        <button type="button" id="modal-cancel-edicion" style="padding: 8px 16px; font-size: 0.875rem; font-weight: 500; color: #475569; background-color: #e2e8f0; border-radius: 6px; transition: background-color 0.15s; cursor: pointer;">Cancelar</button>
                        <button type="submit" style="padding: 8px 16px; font-size: 0.875rem; font-weight: 500; color: white; background-color: #4f46e5; border-radius: 6px; transition: background-color 0.15s; cursor: pointer;">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
        
    </main>

    <div id="modal-nueva-transaccion">
        <div id="modal-nueva-transaccion-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="font-size: 1.5rem; color: #475569; margin: 0; display: flex; align-items: center;">
                    <i data-lucide="plus-circle" style="width: 24px; height: 24px; margin-right: 8px; color: #6366f1;"></i>
                    Nueva Transacci贸n
                </h2>
                <button id="modal-cancel-nueva" style="background: none; border: none; cursor: pointer; color: #64748b;">
                     <i data-lucide="x" style="width: 28px; height: 28px;"></i>
                </button>
            </div>
            
            <form id="form-transaccion" style="display: flex; flex-direction: column; gap: 16px;">
                <div>
                    <label for="tipo" style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569;">Tipo</label>
                    <select id="tipo" required>
                        <option value="ingreso">Ingreso</option>
                        <option value="gasto">Gasto</option>
                        <option value="ahorro">Ahorro</option>
                    </select>
                </div>
                <div>
                    <label for="categoria" style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569;">Categor铆a</label>
                    <select id="categoria" required>
                    </select>
                </div>
                <div id="ahorro-sugerencia-container" style="display: none; flex-direction: column; gap: 8px;">
                    <label for="ahorro-porcentaje" style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569;">Porcentaje de Ahorro Sugerido (20%)</label>
                    <input type="number" id="ahorro-porcentaje" min="0" max="100" step="1" value="20" placeholder="Ej: 20">
                    <p id="ahorro-sugerencia-monto" style="font-size: 0.875rem; color: #4f46e5; font-weight: 600;">Sugerencia: $0.00</p>
                </div>
                <div>
                    <label for="monto" style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569;">Monto ($)</label>
                    <input type="number" id="monto" required min="0.01" step="0.01" placeholder="Ej: 500.00">
                </div>
                <div>
                    <label for="descripcion" style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569;">Descripci贸n</label>
                    <input type="text" id="descripcion" required placeholder="Ej: Pago de alquiler">
                </div>
                <div>
                    <label for="fecha" style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569;">Fecha</label>
                    <input type="date" id="fecha" required>
                </div>
                <button type="submit" id="btn-guardar-transaccion">
                    Guardar Transacci贸n
                </button>
                <div id="form-message" style="text-align: center; margin-top: 8px; font-size: 0.875rem; display: none;"></div>
            </form>
        </div>
    </div>


    <button id="fab-nueva-transaccion" title="A帽adir Transacci贸n">
        <i data-lucide="plus" style="width: 32px; height: 32px; stroke-width: 3;"></i>
    </button>


    <script type="module">
        // --- 1. CONFIGURACIN DE SUPABASE Y LIBRERAS ---
        let createIcons;
        try {
            const lucide = await import('https://cdn.jsdelivr.net/npm/lucide@latest/dist/esm/lucide.js');
            createIcons = lucide.createIcons;
            window.lucideIcons = {
                PlusCircle: lucide.PlusCircle, Trash2: lucide.Trash2, Pencil: lucide.Pencil,
                ListChecks: lucide.ListChecks, XCircle: lucide.XCircle, Target: lucide.Target,
                Plus: lucide.Plus, X: lucide.X, Landmark: lucide.Landmark,
                ArrowUpCircle: lucide.ArrowUpCircle, ArrowDownCircle: lucide.ArrowDownCircle,
                PiggyBank: lucide.PiggyBank, Scale: lucide.Scale, Gem: lucide.Gem
            };
        } catch (e) {
            console.error("Error cr铆tico al cargar Lucide icons:", e);
            createIcons = () => {};    
        }

        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        const SUPABASE_URL = 'https://agbkeubwhbzjyrmzzkjd.supabase.co';    
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnYmtldWJ3aGJ6anlybXp6a2pkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MTA3ODksImV4cCI6MjA3Njk4Njc4OX0.pj3-hUlKcSb3BDuOvhOQD7sMzf5qONQdiLw9nT5MJis';    
        const TABLA_TRANSACCIONES = 'transacciones';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // --- 2. VARIABLES Y ESTADO ---
        const UNICA_CUENTA = 'Global';    
        let todasTransacciones = [];    
        let transaccionesMesActual = [];    
        let mesSeleccionado = '';    
        let resumenMensual = {};    
        
        // --- NUEVO: Variables de Paginaci贸n y Filtro ---
        let paginaActual = 1;
        let filtroActual = 'todos';
        const itemsPorPagina = 10; // Puedes ajustar este n煤mero

        let categorias = JSON.parse(localStorage.getItem('finanzasCategorias')) || {
            ingreso: ['Salario', 'Freelance', 'Venta', 'Intereses', 'Otro Ingreso']
        };
        let categorias50 = JSON.parse(localStorage.getItem('categorias50')) || [
            'Alquiler/Hipoteca', 'Suministros B谩sicos', 'Alimentaci贸n B谩sica',    
            'Salud Esencial', 'Educaci贸n Obligatoria', 'Pagos M铆nimos Deuda'
        ];
        let categorias30 = JSON.parse(localStorage.getItem('categorias30')) || [
            'Transporte', 'Entretenimiento/Ocio', 'Comer Fuera', 'Ropa y Accesorios'
        ];
        let categorias20 = JSON.parse(localStorage.getItem('categorias20')) || [
            'Fondo de Emergencia', 'Inversi贸n Crecimiento', 'Meta Viaje', 'Pago Extra Deuda'
        ];
        
        // --- Referencias del DOM ---
        const tipoSelect = document.getElementById('tipo');
        const categoriaSelect = document.getElementById('categoria');
        const formTransaccion = document.getElementById('form-transaccion');
        const listaTransaccionesEl = document.getElementById('lista-transacciones');
        const formMessageEl = document.getElementById('form-message');
        const fechaInput = document.getElementById('fecha');
        const selectorMesEl = document.getElementById('selector-mes');
        const ahorroPorcentajeInput = document.getElementById('ahorro-porcentaje');    
        const ahorroSugerenciaContainer = document.getElementById('ahorro-sugerencia-container');
        
        const saldoInicialEl = document.getElementById('saldo-inicial');
        const ingresosTotalesEl = document.getElementById('ingresos-totales');
        const balanceNetoEl = document.getElementById('balance-neto');
        const btnGuardarTransaccion = document.getElementById('btn-guardar-transaccion');
        
        const fabNuevaTransaccion = document.getElementById('fab-nueva-transaccion');
        const modalNuevaTransaccion = document.getElementById('modal-nueva-transaccion');
        const modalCancelNueva = document.getElementById('modal-cancel-nueva');

        const modalContainerConfirm = document.getElementById('modal-container');
        const modalConfirmDelete = document.getElementById('modal-confirm');
        const modalCancelConfirm = document.getElementById('modal-cancel');
        const modalContainerEdicion = document.getElementById('modal-container-edicion');
        const formEdicion = document.getElementById('form-edicion');
        const modalCancelEdicion = document.getElementById('modal-cancel-edicion');
        const editTipoSelect = document.getElementById('edit-tipo');
        const editCategoriaSelect = document.getElementById('edit-categoria');
        const editMontoInput = document.getElementById('edit-monto');
        const editDescripcionInput = document.getElementById('edit-descripcion');
        const editFechaInput = document.getElementById('edit-fecha');
        const editIdInput = document.getElementById('edit-id');

        // --- NUEVO: DOM de Paginaci贸n y Filtros ---
        const filterControlsEl = document.querySelector('.filter-controls');
        const paginationControlsEl = document.getElementById('pagination-controls');
        const pageInfoEl = document.getElementById('page-info');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');

        // DOM UI Avanzada (Administraci贸n)
        const categoriasListas = {
            ingreso: document.getElementById('lista-ingreso'),
            'gasto-50': document.getElementById('lista-gasto-50'),
            'gasto-30': document.getElementById('lista-gasto-30'),
            'ahorro-20': document.getElementById('lista-ahorro-20'),
        };
        const categoriasInputs = {
            ingreso: document.getElementById('input-ingreso'),
            'gasto-50': document.getElementById('input-gasto-50'),
            'gasto-30': document.getElementById('input-gasto-30'),
            'ahorro-20': document.getElementById('input-ahorro-20'),
        };
        const categoriasCounts = {
            ingreso: document.getElementById('count-ingreso'),
            'gasto-50': document.getElementById('count-gasto-50'),
            'gasto-30': document.getElementById('count-gasto-30'),
            'ahorro-20': document.getElementById('count-ahorro-20'),
        };
        const btnAgregarGeneral = document.querySelectorAll('.btn-agregar-general');
        
        
        // --- 3. LGICA DE UTILIDAD Y CLCULO ---
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('es-US', { style: 'currency', currency: 'USD' }).format(amount);
        };
        
        function calcularSugerenciaAhorro() {
            const porcentaje = parseFloat(ahorroPorcentajeInput.value) || 0;
            const porcentajeValido = isNaN(porcentaje) || porcentaje < 0 ? 0 : porcentaje;
            const ingresosTotales = (resumenMensual && resumenMensual.ingresosTotales) ? resumenMensual.ingresosTotales : 0;
            const montoSugerido = ingresosTotales * (porcentajeValido / 100);
            document.getElementById('ahorro-sugerencia-monto').textContent = `Sugerencia (${porcentajeValido}% de ${formatCurrency(ingresosTotales)}): ${formatCurrency(montoSugerido)}`;
            ahorroSugerenciaContainer.style.display = (tipoSelect.value === 'ahorro') ? 'flex' : 'none';
        }
        
        function calcularResumenMensual() {
            let totalEntradasMes = 0, totalSalidasMes = 0, ingresosRealesMes = 0;
            let saldoInicial = 0, ahorroAcumuladoTotal = 0;
            let gastoNecesidades = 0, gastoDeseos = 0, gastoAhorroDeudas = 0;
            
            const categorias50Activas = categorias50;
            const categorias30Activas = categorias30;
            const categorias20Activas = categorias20;
            const mesActualSeleccionado = mesSeleccionado;

            todasTransacciones.forEach(t => {
                const monto = t.monto;
                if (t.tipo === 'ahorro') {
                    ahorroAcumuladoTotal += monto;
                }
                if (t.mesAnio < mesActualSeleccionado) {
                    if (t.tipo === 'ingreso') saldoInicial += monto;
                    else if (t.tipo === 'gasto' || t.tipo === 'ahorro') saldoInicial -= monto;
                } else if (t.mesAnio === mesActualSeleccionado) {
                    if (t.tipo === 'ingreso') {    
                        totalEntradasMes += monto;
                        ingresosRealesMes += monto;
                    } else if (t.tipo === 'gasto' || t.tipo === 'ahorro') {
                        totalSalidasMes += monto;    
                        if (t.tipo === 'gasto') {
                            if (categorias50Activas.includes(t.categoria)) gastoNecesidades += monto;
                            else if (categorias30Activas.includes(t.categoria)) gastoDeseos += monto;
                            if (categorias20Activas.includes(t.categoria)) gastoAhorroDeudas += monto;    
                        } else if (t.tipo === 'ahorro') {
                            if (categorias20Activas.includes(t.categoria)) gastoAhorroDeudas += monto;
                        }
                    }
                }
            });
            const balanceNeto = saldoInicial + totalEntradasMes - totalSalidasMes;
            return {    
                ingresosTotales: ingresosRealesMes, gastosTotales: totalSalidasMes, balanceNeto: balanceNeto,    
                saldoInicial: saldoInicial, ahorroAcumuladoTotal: ahorroAcumuladoTotal,
                gastoNecesidades: gastoNecesidades, gastoDeseos: gastoDeseos, gastoAhorroDeudas: gastoAhorroDeudas
            };
        }

        // --- 4. FUNCIONES CRUD CON SUPABASE ---
        function guardarConfiguracionLocal() {
            localStorage.setItem('finanzasCategorias', JSON.stringify(categorias));
            localStorage.setItem('categorias50', JSON.stringify(categorias50));
            localStorage.setItem('categorias30', JSON.stringify(categorias30));
            localStorage.setItem('categorias20', JSON.stringify(categorias20));
        }
        
        async function cargarDatosDesdeSupabase() {
            const { data, error } = await supabase.from(TABLA_TRANSACCIONES).select('id, tipo, categoria, descripcion, monto, fecha, cuenta');    
            if (error) {
                console.error("Error al cargar datos de Supabase:", error);
                listaTransaccionesEl.innerHTML = `<tr><td colspan="6" style="padding: 16px; text-align: center; color: #ef4444;">Error al cargar datos: ${error.message}.</td></tr>`;
                todasTransacciones = [];
            } else {
                todasTransacciones = data.map(t => ({ ...t, monto: parseFloat(t.monto), mesAnio: t.fecha.substring(0, 7) }));
            }
            filtrarYRenderizar();
        }

        async function guardarTransaccion(transaccion) {
            const { error } = await supabase.from(TABLA_TRANSACCIONES).insert([{ ...transaccion, cuenta: UNICA_CUENTA }]);
            if (error) {
                console.error("Error al guardar en Supabase:", error);
                return { success: false, error: error };
            }    
            return { success: true };
        }

        async function eliminarTransaccion(id) {
            const { error } = await supabase.from(TABLA_TRANSACCIONES).delete().eq('id', id);    
            if (error) console.error("Error al eliminar en Supabase:", error);
            else await cargarDatosDesdeSupabase();
        }
        
        async function actualizarTransaccionSupabase(transaccion) {
             const { error } = await supabase.from(TABLA_TRANSACCIONES).update({ ...transaccion, cuenta: UNICA_CUENTA }).eq('id', transaccion.id);
            if (error) {
                console.error("Error al actualizar en Supabase:", error);
                alert("Error al actualizar: " + error.message);
            } else {
                modalContainerEdicion.style.display = 'none';
                await cargarDatosDesdeSupabase();
            }
        }
        
        // --- 5. LGICA DE FILTRADO Y CLCULO ---

        function filtrarYRenderizar() {
            // Filtra por mes y ordena por fecha
            transaccionesMesActual = todasTransacciones
                .filter(t => t.mesAnio === mesSeleccionado)
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                
            resumenMensual = calcularResumenMensual();
            const { ingresosTotales, gastosTotales, balanceNeto, saldoInicial, ahorroAcumuladoTotal, gastoNecesidades, gastoDeseos, gastoAhorroDeudas } = resumenMensual;
            
            renderizarDashboard(ingresosTotales, gastosTotales, balanceNeto, saldoInicial, ahorroAcumuladoTotal, gastoNecesidades, gastoDeseos, gastoAhorroDeudas);
            renderizarPlanificador503020(ingresosTotales, gastoNecesidades, gastoDeseos, gastoAhorroDeudas);
            
            // --- MODIFICADO: Solo llama a la funci贸n principal de renderizado de lista ---
            renderizarListaTransacciones(); 
            
            actualizarCategoriasYCuentas();    
            try { createIcons({ icons: window.lucideIcons }); } catch(e) {}
        }


        // --- 6. LGICA DE RENDERIZACIN DE LA UI ---
        
        function inicializarSelectorMes() {
            const hoy = new Date();
            const year = hoy.getFullYear();
            const month = hoy.getMonth();
            let opcionesHTML = '';
            const mesesNombre = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            for (let i = -6; i <= 5; i++) {
                const fecha = new Date(year, month + i, 1);
                const valor = `${fecha.getFullYear()}-${(fecha.getMonth() + 1).toString().padStart(2, '0')}`;
                const nombre = `${mesesNombre[fecha.getMonth()]} ${fecha.getFullYear()}`;
                opcionesHTML += `<option value="${valor}">${nombre}</option>`;
            }
            selectorMesEl.innerHTML = opcionesHTML;
            mesSeleccionado = `${year}-${(month + 1).toString().padStart(2, '0')}`;
            selectorMesEl.value = mesSeleccionado;
            fechaInput.value = hoy.toISOString().substring(0, 10);

            selectorMesEl.addEventListener('change', (e) => {
                mesSeleccionado = e.target.value;
                // --- NUEVO: Resetea paginaci贸n y filtro al cambiar de mes ---
                paginaActual = 1;
                filtroActual = 'todos';
                // Resetea visualmente los botones de filtro
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('.filter-btn[data-tipo="todos"]').classList.add('active');
                
                filtrarYRenderizar();
            });
        }
        
        function inicializarPestanas() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.dataset.target;
                    tabContents.forEach(content => content.style.display = 'none');
                    tabButtons.forEach(btn => {
                        btn.style.borderColor = 'transparent';
                        btn.style.color = '#64748b';
                        btn.classList.remove('tab-button-active');
                    });
                    document.getElementById(targetId).style.display = 'block';
                    button.style.borderColor = '#4f46e5';
                    button.style.color = '#4f46e5';
                    button.classList.add('tab-button-active');
                    if (targetId === 'seccion-clasificacion-503020') renderizarCategorias();
                    if (targetId === 'seccion-resumen') actualizarCategoriasYCuentas();    
                    try { createIcons({ icons: window.lucideIcons }); } catch(e) {}
                });
            });
        }
        
        function renderizarDashboard(ingresosTotales, gastosTotales, balanceNeto, saldoInicial, ahorroAcumuladoTotal, gastoNecesidades, gastoDeseos, gastoAhorroDeudas) {
            saldoInicialEl.textContent = formatCurrency(saldoInicial);
            ingresosTotalesEl.textContent = formatCurrency(ingresosTotales);
            document.getElementById('gastos-mes').textContent = formatCurrency(gastoNecesidades + gastoDeseos);
            document.getElementById('ahorro-mes').textContent = formatCurrency(gastoAhorroDeudas);
            balanceNetoEl.textContent = formatCurrency(balanceNeto);
            document.getElementById('ahorro-acumulado-total').textContent = formatCurrency(ahorroAcumuladoTotal);
            balanceNetoEl.style.color = (balanceNeto > 0) ? '#10b981' : (balanceNeto < 0) ? '#ef4444' : '#4f46e5';
        }

        // --- FUNCIN PLANIFICADOR 50/30/20 (ACTUALIZADA con "Excedente") ---
        function renderizarPlanificador503020(ingresosTotales, gastoNecesidades, gastoDeseos, gastoAhorroDeudas) {
            document.getElementById('ingreso-neto-503020').textContent = formatCurrency(ingresosTotales);
            
            const objetivo50 = ingresosTotales * 0.5;
            const objetivo30 = ingresosTotales * 0.3;
            const objetivo20 = ingresosTotales * 0.2;
            
            document.getElementById('objetivo-50').textContent = formatCurrency(objetivo50);
            document.getElementById('objetivo-30').textContent = formatCurrency(objetivo30);
            document.getElementById('objetivo-20').textContent = formatCurrency(objetivo20);
            
            document.getElementById('gasto-50').textContent = formatCurrency(gastoNecesidades);
            document.getElementById('gasto-30').textContent = formatCurrency(gastoDeseos);
            document.getElementById('gasto-20').textContent = formatCurrency(gastoAhorroDeudas);

            const restante50 = objetivo50 - gastoNecesidades;
            const restante30 = objetivo30 - gastoDeseos;
            
            // --- 隆NUEVA LGICA "EXCEDENTE"! ---
            const restante20LabelEl = document.getElementById('restante-20-label');
            const restante20MontoEl = document.getElementById('restante-20');
            let restante20;

            if (gastoAhorroDeudas >= objetivo20) {
                // Se cumpli贸 o super贸 la meta
                restante20 = gastoAhorroDeudas - objetivo20; // C谩lculo del excedente (positivo)
                restante20LabelEl.innerHTML = '隆Excedente!: <span id="restante-20"></span>'; // Re-inserta el span
                document.getElementById('restante-20').textContent = formatCurrency(restante20);
            } else {
                // A煤n no se cumple la meta
                restante20 = objetivo20 - gastoAhorroDeudas; // C谩lculo de lo faltante (positivo)
                restante20LabelEl.innerHTML = 'Faltante: <span id="restante-20"></span>'; // Re-inserta el span
                document.getElementById('restante-20').textContent = formatCurrency(restante20);
            }
            // --- FIN DE LA LGICA "EXCEDENTE" ---

            document.getElementById('restante-50').textContent = formatCurrency(restante50);
            document.getElementById('restante-30').textContent = formatCurrency(restante30);
            
            const pct50 = (objetivo50 > 0) ? (gastoNecesidades / objetivo50) * 100 : 0;
            const pct30 = (objetivo30 > 0) ? (gastoDeseos / objetivo30) * 100 : 0;
            const pct20 = (objetivo20 > 0) ? (gastoAhorroDeudas / objetivo20) * 100 : 0;

            const fill50 = document.getElementById('progress-fill-50');
            const restante50Label = document.getElementById('restante-50-label');
            const fill30 = document.getElementById('progress-fill-30');
            const restante30Label = document.getElementById('restante-30-label');
            const fill20 = document.getElementById('progress-fill-20');
            const restante20LabelSpan = document.getElementById('restante-20-label'); // El span padre

            // L贸gica 50%
            fill50.style.width = `${Math.min(pct50, 100)}%`;
            if (gastoNecesidades > objetivo50) {
                fill50.style.backgroundColor = '#dc2626';
                restante50Label.classList.add('progress-remaining-danger');
            } else {
                fill50.style.backgroundColor = '#ef4444';
                restante50Label.classList.remove('progress-remaining-danger');
            }

            // L贸gica 30%
            fill30.style.width = `${Math.min(pct30, 100)}%`;
            if (gastoDeseos > objetivo30) {
                fill30.style.backgroundColor = '#dc2626';
                restante30Label.classList.add('progress-remaining-danger');
            } else {
                fill30.style.backgroundColor = '#f97316';
                restante30Label.classList.remove('progress-remaining-danger');
            }

            // L贸gica 20%
            fill20.style.width = `${Math.min(pct20, 100)}%`;
            if (gastoAhorroDeudas < objetivo20 && ingresosTotales > 0) {
                fill20.style.backgroundColor = '#f97316'; // Naranja (no has llegado)
                restante20LabelSpan.classList.add('progress-remaining-danger');
                restante20LabelSpan.classList.remove('progress-remaining-success');
            } else {
                fill20.style.backgroundColor = '#10b981'; // Verde
                restante20LabelSpan.classList.remove('progress-remaining-danger');
                if (gastoAhorroDeudas >= objetivo20 && ingresosTotales > 0) {
                     restante20LabelSpan.classList.add('progress-remaining-success');
                } else {
                     restante20LabelSpan.classList.remove('progress-remaining-success');
                }
            }
        }

        // --- FUNCIN DE RENDERIZAR LISTA (ACTUALIZADA con Filtro y Paginaci贸n) ---
        function renderizarListaTransacciones() {
            // 1. Aplicar Filtro
            const transaccionesFiltradas = transaccionesMesActual.filter(t => {
                if (filtroActual === 'todos') return true;
                return t.tipo === filtroActual;
            });

            // 2. Calcular Paginaci贸n
            const totalPaginas = Math.ceil(transaccionesFiltradas.length / itemsPorPagina) || 1;
            // Asegurarse de que la p谩gina actual no est茅 fuera de los l铆mites
            if (paginaActual > totalPaginas) paginaActual = totalPaginas;

            const inicio = (paginaActual - 1) * itemsPorPagina;
            const fin = inicio + itemsPorPagina;
            const transaccionesAMostrar = transaccionesFiltradas.slice(inicio, fin);

            // 3. Renderizar Tabla
            if (transaccionesAMostrar.length === 0) {
                listaTransaccionesEl.innerHTML = `<tr><td colspan="6" style="padding: 16px; text-align: center; color: #64748b;">No hay transacciones que coincidan con el filtro.</td></tr>`;
            } else {
                listaTransaccionesEl.innerHTML = transaccionesAMostrar.map(t => {
                    const esIngreso = t.tipo === 'ingreso';
                    const esAhorro = t.tipo === 'ahorro';
                    let montoClase = esIngreso ? 'color: #10b981; font-weight: 600;' : esAhorro ? 'color: #3b82f6; font-weight: 600;' : 'color: #ef4444; font-weight: 600;';
                    let tipoClase = esIngreso ? 'background-color: #d1fae5; color: #065f46;' : esAhorro ? 'background-color: #dbeafe; color: #1e40af;' : 'background-color: #fee2e2; color: #991b1b;';
                    let tipoTexto = esIngreso ? 'INGRESO' : esAhorro ? 'AHORRO' : 'GASTO';
                    let categoriaTexto = t.categoria || 'N/A';
                    let badgeColor = '';
                    if (esAhorro || categorias20.includes(t.categoria)) badgeColor = '#10b981';
                    else if (categorias50.includes(t.categoria)) badgeColor = '#ef4444';
                    else if (categorias30.includes(t.categoria)) badgeColor = '#f97316';

                    return `
                        <tr style="transition: background-color 0.15s;">
                            <td style="padding: 12px; font-size: 0.875rem; color: #64748b;">${t.fecha}</td>
                            <td style="padding: 12px;"><span style="${tipoClase} font-weight: 600; font-size: 0.75rem; padding: 4px 8px; border-radius: 999px;">${tipoTexto}</span></td>
                            <td style="padding: 12px; font-size: 0.875rem; color: #1e293b; display: flex; align-items: center;">
                                ${badgeColor ? `<span style="width: 8px; height: 8px; border-radius: 50%; background-color: ${badgeColor}; margin-right: 8px;"></span>` : ''}
                                ${categoriaTexto}
                            </td>
                            <td style="padding: 12px; font-size: 0.875rem; color: #64748b;" class="truncate">${t.descripcion}</td>
                            <td style="padding: 12px; text-align: right; font-size: 0.875rem; ${montoClase}">${formatCurrency(t.monto)}</td>
                            <td style="padding: 12px; text-align: right; font-size: 0.875rem;">
                                <button data-id="${t.id}" class="btn-editar" style="color: #6366f1;"><i data-lucide="pencil" style="width: 18px; height: 18px; display: inline-block;"></i></button>
                                <button data-id="${t.id}" class="btn-eliminar" style="color: #ef4444;"><i data-lucide="trash-2" style="width: 18px; height: 18px; display: inline-block;"></i></button>
                            </td>
                        </tr>`;
                }).join('');
            }
            
            // 4. Actualizar Controles de Paginaci贸n
            if (transaccionesFiltradas.length > itemsPorPagina) {
                paginationControlsEl.style.display = 'flex';
                pageInfoEl.textContent = `P谩gina ${paginaActual} de ${totalPaginas}`;
                prevPageBtn.disabled = (paginaActual === 1);
                nextPageBtn.disabled = (paginaActual === totalPaginas);
            } else {
                paginationControlsEl.style.display = 'none';
            }
            
            try { createIcons({ icons: window.lucideIcons }); } catch (e) {}
        }
        // --- FIN DE LA FUNCIN DE RENDERIZAR LISTA ---


        // --- 7. MANEJO DE EVENTOS ---

        function actualizarCategoriasYCuentas() {
            actualizarCategorias();
        }

        function actualizarCategorias() {
            const tipo = tipoSelect.value;
            let html = '';
            if (tipo === 'ingreso') {
                html = (categorias.ingreso || []).map(cat => `<option value="${cat}">${cat}</option>`).join('');
            } else if (tipo === 'gasto') {
                html = `<optgroup label="50% Necesidades">` + categorias50.map(cat => `<option value="${cat}">${cat}</option>`).join('') + `</optgroup>`;
                html += `<optgroup label="30% Deseos">` + categorias30.map(cat => `<option value="${cat}">${cat}</option>`).join('') + `</optgroup>`;
            } else if (tipo === 'ahorro') {
                html = `<optgroup label="20% Ahorro/Deuda">` + categorias20.map(cat => `<option value="${cat}">${cat}</option>`).join('') + `</optgroup>`;
            }
            categoriaSelect.innerHTML = html;
            calcularSugerenciaAhorro();    
        }
        
        // --- EVENT HANDLERS ---
        tipoSelect.addEventListener('change', actualizarCategorias);
        document.getElementById('monto').addEventListener('input', calcularSugerenciaAhorro);
        ahorroPorcentajeInput.addEventListener('input', calcularSugerenciaAhorro);

        formTransaccion.addEventListener('submit', async (e) => {
            e.preventDefault();
            btnGuardarTransaccion.disabled = true;
            btnGuardarTransaccion.textContent = "Guardando...";

            const fechaTransaccion = document.getElementById('fecha').value;
            const transaccion = {
                tipo: tipoSelect.value, categoria: categoriaSelect.value,
                monto: parseFloat(document.getElementById('monto').value),
                descripcion: document.getElementById('descripcion').value.trim(),
                fecha: fechaTransaccion,
            };

            if (transaccion.descripcion && transaccion.monto > 0) {    
                const result = await guardarTransaccion(transaccion);
                if (result.success) {
                    // --- NUEVO: Resetear filtro y p谩gina al guardar ---
                    paginaActual = 1;
                    filtroActual = 'todos';
                    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelector('.filter-btn[data-tipo="todos"]').classList.add('active');
                    
                    await cargarDatosDesdeSupabase();    
                    formMessageEl.textContent = "隆Transacci贸n guardada con 茅xito!";
                    formMessageEl.style.color = '#10b981';
                    formTransaccion.reset();
                    fechaInput.value = new Date().toISOString().substring(0, 10);
                    modalNuevaTransaccion.style.display = 'none';
                } else {
                    formMessageEl.textContent = `Error al guardar: ${result.error.message}.`;
                    formMessageEl.style.color = '#ef4444';
                }
            } else {
                formMessageEl.textContent = "Por favor, complete todos los campos correctamente.";
                formMessageEl.style.color = '#ef4444';
            }
            formMessageEl.style.display = 'block';
            setTimeout(() => formMessageEl.style.display = 'none', 3000);
            btnGuardarTransaccion.disabled = false;
            btnGuardarTransaccion.textContent = "Guardar Transacci贸n";
        });
        
        listaTransaccionesEl.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.btn-eliminar');
            const editButton = e.target.closest('.btn-editar');
            if (deleteButton) mostrarModalConfirmacion(deleteButton.dataset.id);
            if (editButton) mostrarModalEdicion(editButton.dataset.id);
        });

        let idAeliminar = null;
        function mostrarModalConfirmacion(id) {
            idAeliminar = id;
            modalContainerConfirm.style.display = 'flex';
        }

        modalCancelConfirm.addEventListener('click', () => {
            modalContainerConfirm.style.display = 'none';
            idAeliminar = null;
        });

        modalConfirmDelete.addEventListener('click', () => {
            if (idAeliminar) eliminarTransaccion(idAeliminar);
            modalContainerConfirm.style.display = 'none';
            idAeliminar = null;
        });
        
        function actualizarOpcionesEdicion(currentTipo, currentCategoria) {    
            const llenarCategorias = (tipo) => {
                let html = '';
                if (tipo === 'ingreso') {
                    html = (categorias.ingreso || []).map(cat => `<option value="${cat}">${cat}</option>`).join('');
                } else if (tipo === 'gasto') {
                    html = `<optgroup label="50% Necesidades">` + categorias50.map(cat => `<option value="${cat}">${cat}</option>`).join('') + `</optgroup>`;
                    html += `<optgroup label="30% Deseos">` + categorias30.map(cat => `<option value="${cat}">${cat}</option>`).join('') + `</optgroup>`;
                } else if (tipo === 'ahorro') {
                    html = `<optgroup label="20% Ahorro/Deuda">` + categorias20.map(cat => `<option value="${cat}">${cat}</option>`).join('') + `</optgroup>`;
                }
                editCategoriaSelect.innerHTML = html;
                editCategoriaSelect.value = currentCategoria;
            };
            editTipoSelect.value = currentTipo;
            llenarCategorias(currentTipo);
            editTipoSelect.onchange = null;    
            editTipoSelect.onchange = () => llenarCategorias(editTipoSelect.value);
        }
        
        formEdicion.addEventListener('submit', (e) => {
            e.preventDefault();
            const transaccionEditada = {
                id: editIdInput.value, tipo: editTipoSelect.value,
                categoria: editCategoriaSelect.value, monto: parseFloat(editMontoInput.value),
                descripcion: editDescripcionInput.value.trim(), fecha: editFechaInput.value,
            };
            if (transaccionEditada.descripcion && transaccionEditada.monto > 0) {    
                actualizarTransaccionSupabase(transaccionEditada);
            } else {
                alert("Por favor, complete todos los campos correctamente.");
            }
        });
        
        modalCancelEdicion.addEventListener('click', () => {
            modalContainerEdicion.style.display = 'none';
            editTipoSelect.onchange = null;    
        });
        
        function mostrarModalEdicion(id) {
            const transaccion = todasTransacciones.find(t => t.id === id);    
            if (!transaccion) return;
            editIdInput.value = transaccion.id;
            editMontoInput.value = transaccion.monto.toFixed(2);
            editDescripcionInput.value = transaccion.descripcion;
            editFechaInput.value = transaccion.fecha;
            actualizarOpcionesEdicion(transaccion.tipo, transaccion.categoria);    
            modalContainerEdicion.style.display = 'flex';
        }

        // --- Funciones Pesta帽a CLASIFICACIN (Sin cambios) ---
        function agregarGeneral(tipo, nombre) {
            nombre = nombre.trim();
            if (!nombre) return false;
            let array;
            if (tipo === 'ingreso') array = categorias.ingreso;
            else if (tipo === 'gasto-50') array = categorias50;
            else if (tipo === 'gasto-30') array = categorias30;
            else if (tipo === 'ahorro-20') array = categorias20;
            else return false;

            if (!array.includes(nombre)) {
                array.push(nombre);    
                guardarConfiguracionLocal();
                renderizarCategorias();
                categoriasInputs[tipo].value = '';    
                actualizarCategoriasYCuentas();    
                return true;
            } else {
                alert(`La categor铆a "${nombre}" ya existe.`);
            }
            return false;
        }

        function eliminarGeneral(tipo, nombre) {
            let array;
            if (tipo === 'ingreso') array = categorias.ingreso;
            else if (tipo === 'gasto-50') array = categorias50;
            else if (tipo === 'gasto-30') array = categorias30;
            else if (tipo === 'ahorro-20') array = categorias20;
            else return false;
            
            const index = array.indexOf(nombre);
            if (index > -1) {
                const transaccionesActivas = todasTransacciones.filter(t => t.categoria === nombre);
                if (transaccionesActivas.length > 0) {
                    alert(`No se puede eliminar porque tiene ${transaccionesActivas.length} transacciones registradas.`);
                    return false;
                }
                array.splice(index, 1);
                guardarConfiguracionLocal();
                renderizarCategorias();
                actualizarCategoriasYCuentas();    
                return true;
            }
            return false;
        }
        
        function renderizarCategorias() {
            // Ingresos
            categoriasListas.ingreso.innerHTML = '';
            categorias.ingreso.forEach(categoria => {
                const li = document.createElement('li');
                li.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 6px; background-color: #f8fafc; border: 1px solid #e2e8f0;';
                li.innerHTML = `<span style="color: #1e293b; font-weight: 500;">${categoria}</span><button data-tipo="ingreso" data-nombre="${categoria}" class="btn-eliminar-general" style="color: #ef4444; background: none; border: none; cursor: pointer;"><i data-lucide="x-circle" style="width: 18px; height: 18px; display: inline-block;"></i></button>`;
                categoriasListas.ingreso.appendChild(li);
            });
            categoriasCounts.ingreso.textContent = `(${categorias.ingreso.length} categor铆as)`;

            // 50%
            categoriasListas['gasto-50'].innerHTML = '';
            categorias50.forEach(categoria => {
                const li = document.createElement('li');
                li.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 6px; background-color: #fef2f2; border: 1px solid #fecaca;';
                li.innerHTML = `<span style="color: #1e293b; font-weight: 500;">${categoria}</span><button data-tipo="gasto-50" data-nombre="${categoria}" class="btn-eliminar-general" style="color: #ef4444; background: none; border: none; cursor: pointer;"><i data-lucide="x-circle" style="width: 18px; height: 18px; display: inline-block;"></i></button>`;
                categoriasListas['gasto-50'].appendChild(li);
            });
            categoriasCounts['gasto-50'].textContent = `(${categorias50.length} categor铆as)`;

            // 30%
            categoriasListas['gasto-30'].innerHTML = '';
            categorias30.forEach(categoria => {
                const li = document.createElement('li');
                li.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 6px; background-color: #fff7ed; border: 1px solid #fed7aa;';
                li.innerHTML = `<span style="color: #1e293b; font-weight: 500;">${categoria}</span><button data-tipo="gasto-30" data-nombre="${categoria}" class="btn-eliminar-general" style="color: #ef4444; background: none; border: none; cursor: pointer;"><i data-lucide="x-circle" style="width: 18px; height: 18px; display: inline-block;"></i></button>`;
                categoriasListas['gasto-30'].appendChild(li);
            });
            categoriasCounts['gasto-30'].textContent = `(${categorias30.length} categor铆as)`;

            // 20%
            categoriasListas['ahorro-20'].innerHTML = '';
            categorias20.forEach(categoria => {
                const li = document.createElement('li');
                li.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 6px; background-color: #ecfdf5; border: 1px solid #a7f3d0;';
                li.innerHTML = `<span style="color: #1e293b; font-weight: 500;">${categoria}</span><button data-tipo="ahorro-20" data-nombre="${categoria}" class="btn-eliminar-general" style="color: #ef4444; background: none; border: none; cursor: pointer;"><i data-lucide="x-circle" style="width: 18px; height: 18px; display: inline-block;"></i></button>`;
                categoriasListas['ahorro-20'].appendChild(li);
            });
            categoriasCounts['ahorro-20'].textContent = `(${categorias20.length} categor铆as)`;

            try { createIcons({ icons: window.lucideIcons }); } catch(e) {}
        }
        
        btnAgregarGeneral.forEach(button => {
            button.addEventListener('click', (e) => {
                const tipo = e.currentTarget.dataset.tipo;
                agregarGeneral(tipo, categoriasInputs[tipo].value);
            });
        });
        
        document.getElementById('seccion-clasificacion-503020').addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.btn-eliminar-general');
            if (deleteButton) {
                if(confirm(`驴Est谩s seguro de que quieres eliminar la categor铆a "${deleteButton.dataset.nombre}"?`)) {
                    eliminarGeneral(deleteButton.dataset.tipo, deleteButton.dataset.nombre);
                }
            }
        });

        // --- NUEVO: Listeners para FAB, Filtros y Paginaci贸n ---
        fabNuevaTransaccion.addEventListener('click', () => {
            modalNuevaTransaccion.style.display = 'flex';
            try { createIcons({ icons: window.lucideIcons }); } catch(e) {}
        });

        modalCancelNueva.addEventListener('click', () => {
             modalNuevaTransaccion.style.display = 'none';
        });

        filterControlsEl.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                
                filtroActual = e.target.dataset.tipo;
                paginaActual = 1; // Resetea la p谩gina al cambiar de filtro
                renderizarListaTransacciones();
            }
        });

        prevPageBtn.addEventListener('click', () => {
            if (paginaActual > 1) {
                paginaActual--;
                renderizarListaTransacciones();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            // El c谩lculo de totalPaginas se hace dentro de renderizarListaTransacciones
            // Solo necesitamos incrementar y la funci贸n se encargar谩 del l铆mite
            paginaActual++;
            renderizarListaTransacciones();
        });

        // --- 8. INICIO DE LA APLICACIN ---
        inicializarPestanas();    
        inicializarSelectorMes();
        actualizarCategoriasYCuentas();    
        cargarDatosDesdeSupabase();    
        document.getElementById('tab-resumen').click();

        try {
            createIcons({ icons: window.lucideIcons });
        } catch(e) {
            console.warn("Error al cargar iconos principales.", e.message);
        }
    </script>
</body>
</html>
