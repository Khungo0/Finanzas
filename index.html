<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas 50/30/20</title>
    
    <link rel="icon" type="image/png" href="mi-icono.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .card-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .category-bar-container { height: 1rem; border-radius: 0.25rem; overflow: hidden; display: flex; }
        .category-bar-segment { height: 100%; transition: width 0.5s ease-in-out; }

        /* Estilos clave para el Gr√°fico 50/30/20 */
        .budget-ring {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            /* Definici√≥n de los segmentos del anillo con variables CSS */
            background: conic-gradient(
                #ef4444 0% var(--pct-50),
                #f97316 var(--pct-50) calc(var(--pct-50) + var(--pct-30)),
                #10b981 calc(var(--pct-50) + var(--pct-30)) 100%
            );
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            transition: all 0.5s ease;
        }
        .budget-ring::after {
            content: attr(data-total);
            background: #f8fafc;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e293b;
        }
    </style>
</head>
<body class="p-4 md:p-10">

    <header class="mb-10 text-center">
        <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">üéØ Finanzas 50/30/20</h1>
        <p id="auth-status" class="text-sm text-green-600 mt-1">Conectado a la nube. Datos en Supabase. ‚òÅÔ∏è</p>
    </header>

    <div class="max-w-6xl mx-auto mb-8 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="md:col-span-1 flex justify-between items-center bg-white p-4 rounded-xl card-shadow border border-gray-100">
            <label for="selector-mes" class="text-lg font-semibold text-gray-700">Mes de An√°lisis:</label>
            <select id="selector-mes" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 w-40">
                </select>
        </div>
    </div>
    
    <main class="max-w-6xl mx-auto">
        
        <section id="tabs-container" class="mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-resumen" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition duration-150 border-indigo-500 text-indigo-600" data-target="seccion-resumen">
                        Dashboard y Transacciones
                    </button>
                    <button id="tab-categorias" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition duration-150" data-target="seccion-categorias">
                        Administrar Cuentas y Categor√≠as
                    </button>
                </nav>
            </div>
        </section>

        <div id="seccion-resumen" class="tab-content">
            
            <section id="resumen-dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <div class="bg-white p-6 rounded-xl card-shadow border-l-4 border-gray-500">
                    <h2 class="text-lg font-medium text-gray-500">Saldo Inicial</h2>
                    <p id="saldo-inicial" class="text-3xl font-bold text-gray-800 mt-1">$0.00</p>
                </div>

                <div class="bg-white p-6 rounded-xl card-shadow border-l-4 border-green-500">
                    <h2 class="text-lg font-medium text-gray-500">Ingresos Totales</h2>
                    <p id="ingresos-totales" class="text-3xl font-bold text-green-600 mt-1">$0.00</p>
                </div>

                <div class="bg-white p-6 rounded-xl card-shadow border-l-4 border-red-500">
                    <h2 class="text-lg font-medium text-gray-500">Salidas (Gastos + Ahorro)</h2>
                    <p id="gastos-totales" class="text-3xl font-bold text-red-600 mt-1">$0.00</p>
                </div>

                <div class="bg-white p-6 rounded-xl card-shadow border-l-4 border-indigo-500">
                    <h2 class="text-lg font-medium text-gray-500">Saldo Final</h2>
                    <p id="balance-neto" class="text-3xl font-bold mt-1 text-indigo-700">$0.00</p>
                </div>
            </section>

            <section id="planificador-50-30-20" class="bg-white p-8 rounded-xl card-shadow mb-10 border border-gray-100">
                <h2 class="text-2xl font-bold mb-6 text-gray-700 flex items-center">
                    <i data-lucide="target" class="w-6 h-6 mr-2 text-pink-500"></i>
                    Planificaci√≥n 50/30/20 (Basado en Ingresos)
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 items-center">
                    <div class="lg:col-span-1 text-center">
                        <div id="budget-ring" class="budget-ring" data-total="0%"></div>
                        <p class="text-lg font-semibold text-gray-600 mt-4">Porcentaje de Ingreso Usado</p>
                        <p id="ingreso-neto-503020" class="text-xl font-bold text-gray-800">$0.00</p>
                    </div>

                    <div class="lg:col-span-3 space-y-4">
                        <div class="grid grid-cols-3 gap-4 text-sm font-medium text-center border-b pb-2">
                            <span class="text-red-600">50% Necesidades</span>
                            <span class="text-orange-600">30% Deseos</span>
                            <span class="text-emerald-600">20% Ahorro/Deudas</span>
                        </div>

                        <div class="grid grid-cols-3 gap-4">
                            <div class="p-3 bg-red-50 rounded-lg border border-red-200" id="box-50">
                                <p class="text-red-700 font-bold">Objetivo: <span id="objetivo-50">$0.00</span></p>
                                <p class="text-gray-600">Gastado: <span id="gasto-50" class="font-semibold">$0.00</span></p>
                            </div>
                            <div class="p-3 bg-orange-50 rounded-lg border border-orange-200" id="box-30">
                                <p class="text-orange-700 font-bold">Objetivo: <span id="objetivo-30">$0.00</span></p>
                                <p class="text-gray-600">Gastado: <span id="gasto-30" class="font-semibold">$0.00</span></p>
                            </div>
                            <div class="p-3 bg-emerald-50 rounded-lg border border-emerald-200" id="box-20">
                                <p class="text-emerald-700 font-bold">Objetivo: <span id="objetivo-20">$0.00</span></p>
                                <p class="text-gray-600">Aportado: <span id="gasto-20" class="font-semibold">$0.00</span></p>
                            </div>
                        </div>

                        <p class="text-xs text-gray-500 pt-2">
                            *Nota: Las categor√≠as **Vivienda, Servicios, Salud, Educaci√≥n y Deudas** se consideran **Necesidades** (50%). Las transacciones de tipo **Ahorro** m√°s la categor√≠a **Deudas** cuentan como **Ahorro/Deudas** (20%). El resto es **Deseos** (30%).
                        </p>
                    </div>
                </div>
            </section>
            
            <section class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-10">
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-xl card-shadow border border-gray-100">
                        <h2 class="text-2xl font-bold mb-4 text-gray-700 flex items-center">
                            <i data-lucide="plus-circle" class="w-6 h-6 mr-2 text-indigo-500"></i>
                            Nueva Transacci√≥n
                        </h2>
                        <form id="form-transaccion" class="space-y-4">
                            
                            <div>
                                <label for="tipo" class="block text-sm font-medium text-gray-700">Tipo</label>
                                <select id="tipo" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="ingreso">Ingreso</option>
                                    <option value="gasto">Gasto</option>
                                    <option value="ahorro">Ahorro</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="cuenta" class="block text-sm font-medium text-gray-700">Cuenta/Fondo</label>
                                <select id="cuenta" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                                </select>
                            </div>

                            <div>
                                <label for="categoria" class="block text-sm font-medium text-gray-700">Categor√≠a</label>
                                <select id="categoria" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                                </select>
                            </div>

                            <div id="ahorro-sugerencia-container" class="space-y-2 hidden">
                                <label for="ahorro-porcentaje" class="block text-sm font-medium text-gray-700">Porcentaje de Ahorro Sugerido (20%)</label>
                                <input type="number" id="ahorro-porcentaje" min="0" max="100" step="1" value="20" placeholder="Ej: 20" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                                <p id="ahorro-sugerencia-monto" class="text-sm text-indigo-600 font-semibold mt-1">Sugerencia: $0.00</p>
                            </div>

                            <div>
                                <label for="monto" class="block text-sm font-medium text-gray-700">Monto ($)</label>
                                <input type="number" id="monto" required min="0.01" step="0.01" placeholder="Ej: 500.00" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>

                            <div>
                                <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripci√≥n</label>
                                <input type="text" id="descripcion" required placeholder="Ej: Pago de alquiler" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            
                            <div>
                                <label for="fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                                <input type="date" id="fecha" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>

                            <button type="submit" class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-md transition duration-150">
                                Guardar Transacci√≥n
                            </button>
                            <div id="form-message" class="text-center mt-2 text-sm hidden"></div>
                        </form>
                    </div>
                </div>
                
                <div class="lg:col-span-3 space-y-6">
                    <div class="bg-white p-6 rounded-xl card-shadow border border-gray-100">
                        <h2 class="text-2xl font-bold mb-4 text-gray-700">Resumen de Fondos por Cuenta</h2>
                        <div id="resumen-cuentas" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            <p class="text-gray-500">Calculando saldos...</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl card-shadow border border-gray-100">
                        <h2 class="text-2xl font-bold mb-4 text-gray-700">Distribuci√≥n de Ingresos y Gastos</h2>
                        
                        <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">Gastos por Categor√≠a</h3>
                        <div id="gastos-por-categoria" class="space-y-3">
                            <p class="text-gray-500 text-center">No hay gastos registrados a√∫n.</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 pt-6 mb-4">Ingresos por Categor√≠a</h3>
                        <div id="ingresos-por-categoria" class="space-y-3">
                            <p class="text-gray-500 text-center py-4">No hay ingresos registrados a√∫n.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="bg-white p-6 rounded-xl card-shadow border border-gray-100">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Historial de Transacciones del Mes</h2>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cuenta</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categor√≠a</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci√≥n</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="lista-transacciones" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="7" class="p-4 text-center text-gray-500">Cargando transacciones...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <div id="seccion-categorias" class="tab-content hidden">
            <div class="bg-white p-6 rounded-xl card-shadow border border-gray-100">
                <h2 class="text-2xl font-bold mb-6 text-gray-700 flex items-center">
                    <i data-lucide="list-checks" class="w-6 h-6 mr-2 text-indigo-500"></i>
                    Administraci√≥n de Cuentas y Categor√≠as
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    
                    <div id="admin-cuentas-container">
                        <h3 class="text-xl font-semibold mb-3 text-purple-700 border-b pb-1">Cuentas/Fondos <span id="count-cuenta" class="text-sm font-normal text-gray-500"></span></h3>
                        <ul id="lista-cuenta" class="space-y-3">
                            </ul>
                        <div class="mt-4">
                            <input type="text" id="input-cuenta" placeholder="Nueva cuenta (Ej: Banco)" class="w-full p-2 border border-gray-300 rounded-lg text-sm mb-2 focus:ring-purple-500">
                            <button data-tipo="cuenta" class="btn-agregar-general w-full py-2 bg-purple-500 hover:bg-purple-600 text-white font-medium rounded-lg text-sm transition duration-150">Agregar Cuenta</button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-green-700 border-b pb-1">Ingresos <span id="count-ingreso" class="text-sm font-normal text-gray-500"></span></h3>
                        <ul id="lista-ingreso" class="space-y-3">
                        </ul>
                        <div class="mt-4">
                            <input type="text" id="input-ingreso" placeholder="Nueva categor√≠a de Ingreso" class="w-full p-2 border border-gray-300 rounded-lg text-sm mb-2 focus:ring-green-500">
                            <button data-tipo="ingreso" class="btn-agregar-general w-full py-2 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg text-sm transition duration-150">Agregar</button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-red-700 border-b pb-1">Gastos <span id="count-gasto" class="text-sm font-normal text-gray-500"></span></h3>
                        <ul id="lista-gasto" class="space-y-3">
                        </ul>
                        <div class="mt-4">
                            <input type="text" id="input-gasto" placeholder="Nueva categor√≠a de Gasto" class="w-full p-2 border border-gray-300 rounded-lg text-sm mb-2 focus:ring-red-500">
                            <button data-tipo="gasto" class="btn-agregar-general w-full py-2 bg-red-500 hover:bg-red-600 text-white font-medium rounded-lg text-sm transition duration-150">Agregar</button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-blue-700 border-b pb-1">Ahorros <span id="count-ahorro" class="text-sm font-normal text-gray-500"></span></h3>
                        <ul id="lista-ahorro" class="space-y-3">
                        </ul>
                        <div class="mt-4">
                            <input type="text" id="input-ahorro" placeholder="Nueva categor√≠a de Ahorro" class="w-full p-2 border border-gray-300 rounded-lg text-sm mb-2 focus:ring-blue-500">
                            <button data-tipo="ahorro" class="btn-agregar-general w-full py-2 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-lg text-sm transition duration-150">Agregar</button>
                        </div>
                    </div>

                </div>

            </div>
        </div>
        <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-lg p-6 max-w-sm w-full card-shadow">
                <h3 id="modal-title" class="text-lg font-semibold mb-3 text-gray-800">Confirmar Eliminaci√≥n</h3>
                <p id="modal-body" class="text-gray-600 mb-4">¬øEst√°s seguro de que quieres eliminar esta transacci√≥n?</p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel" class="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button id="modal-confirm" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition">Eliminar</button>
                </div>
            </div>
        </div>

        <div id="modal-container-edicion" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-lg p-6 max-w-lg w-full card-shadow">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Editar Transacci√≥n</h3>
                <form id="form-edicion" class="space-y-4">
                    <input type="hidden" id="edit-id">

                    <div>
                        <label for="edit-tipo" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="edit-tipo" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="ingreso">Ingreso</option>
                            <option value="gasto">Gasto</option>
                            <option value="ahorro">Ahorro</option>
                        </select>
                    </div>

                    <div>
                        <label for="edit-cuenta" class="block text-sm font-medium text-gray-700">Cuenta/Fondo</label>
                        <select id="edit-cuenta" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                            </select>
                    </div>

                    <div>
                        <label for="edit-categoria" class="block text-sm font-medium text-gray-700">Categor√≠a</label>
                        <select id="edit-categoria" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                            </select>
                    </div>
                    
                    <div>
                        <label for="edit-monto" class="block text-sm font-medium text-gray-700">Monto ($)</label>
                        <input type="number" id="edit-monto" required min="0.01" step="0.01" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div>
                        <label for="edit-descripcion" class="block text-sm font-medium text-gray-700">Descripci√≥n</label>
                        <input type="text" id="edit-descripcion" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div>
                        <label for="edit-fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                        <input type="date" id="edit-fecha" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="modal-cancel-edicion" class="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>

    </main>

    <script type="module">
        // --- 1. CONFIGURACI√ìN DE SUPABASE Y LIBRER√çAS ---
        let createIcons;
        try {
            const lucide = await import('https://cdn.jsdelivr.net/npm/lucide@latest/dist/esm/lucide.js');
            createIcons = lucide.createIcons;
            window.lucideIcons = {
                Home: lucide.Home, DollarSign: lucide.DollarSign, ArrowUpCircle: lucide.ArrowUpCircle,
                ArrowDownCircle: lucide.ArrowDownCircle, PlusCircle: lucide.PlusCircle, Trash2: lucide.Trash2,
                Gem: lucide.Gem, ListChecks: lucide.ListChecks, XCircle: lucide.XCircle,
                Wallet: lucide.Wallet, Pencil: lucide.Pencil, Edit: lucide.Edit,
                Repeat: lucide.Repeat, Target: lucide.Target, BarChart3: lucide.BarChart3
            };
        } catch (e) {
            console.error("Error cr√≠tico al cargar Lucide icons:", e);
            createIcons = () => {}; 
        }

        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');

        // CREDENCIALES DE SUPABASE
        const SUPABASE_URL = 'https://agbkeubwhbzjyrmzzkjd.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnYmtldWJ3aGJ6anlybXp6a2pkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MTA3ODksImV4cCI6MjA3Njk4Njc4OX0.pj3-hUlKcSb3BDuOvhOQD7sMzf5qONQdiLw9nT5MJis'; 
        const TABLA_TRANSACCIONES = 'transacciones';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // --- 2. VARIABLES Y ESTADO ---
        let todasTransacciones = []; 
        let transaccionesMesActual = []; 
        let mesSeleccionado = ''; 
        let resumenMensual = {}; 
        
        let categorias = JSON.parse(localStorage.getItem('finanzasCategorias')) || {
            ingreso: ['Salario', 'Freelance', 'Inversiones', 'Venta', 'Regalo', 'Otro Ingreso'],
            gasto: ['Vivienda', 'Alimentaci√≥n', 'Transporte', 'Ocio', 'Deudas', 'Servicios', 'Salud', 'Educaci√≥n', 'Otro Gasto'],
            ahorro: ['Fondo de Emergencia', 'Meta Viaje', 'Meta Casa', 'Inversi√≥n Crecimiento']
        };
        
        let cuentas = JSON.parse(localStorage.getItem('finanzasCuentas')) || [
            'Efectivo', 'Mercantil', 'Binance', 'Zinli'
        ];
        
        // Referencias del DOM
        const tipoSelect = document.getElementById('tipo');
        const categoriaSelect = document.getElementById('categoria');
        const cuentaSelect = document.getElementById('cuenta'); 
        const formTransaccion = document.getElementById('form-transaccion');
        const listaTransaccionesEl = document.getElementById('lista-transacciones');
        const gastosPorCategoriaEl = document.getElementById('gastos-por-categoria');
        const ingresosPorCategoriaEl = document.getElementById('ingresos-por-categoria');
        const formMessageEl = document.getElementById('form-message');
        const fechaInput = document.getElementById('fecha');
        const selectorMesEl = document.getElementById('selector-mes');
        const ahorroPorcentajeInput = document.getElementById('ahorro-porcentaje'); 
        const ahorroSugerenciaContainer = document.getElementById('ahorro-sugerencia-container');
        const budgetRingEl = document.getElementById('budget-ring');
        const saldoInicialEl = document.getElementById('saldo-inicial');
        const ingresosTotalesEl = document.getElementById('ingresos-totales');
        
        // DOM UI Avanzada
        const categoriasListas = {
            ingreso: document.getElementById('lista-ingreso'),
            gasto: document.getElementById('lista-gasto'),
            ahorro: document.getElementById('lista-ahorro'),
            cuenta: document.getElementById('lista-cuenta') 
        };
        const categoriasInputs = {
            ingreso: document.getElementById('input-ingreso'),
            gasto: document.getElementById('input-gasto'),
            ahorro: document.getElementById('input-ahorro'),
            cuenta: document.getElementById('input-cuenta') 
        };
        const categoriasCounts = {
            ingreso: document.getElementById('count-ingreso'),
            gasto: document.getElementById('count-gasto'),
            ahorro: document.getElementById('count-ahorro'),
            cuenta: document.getElementById('count-cuenta') 
        };
        const btnAgregarGeneral = document.querySelectorAll('.btn-agregar-general');
        
        const modalContainerConfirm = document.getElementById('modal-container');
        const modalConfirmDelete = document.getElementById('modal-confirm');
        const modalCancelConfirm = document.getElementById('modal-cancel');
        const modalContainerEdicion = document.getElementById('modal-container-edicion');
        const formEdicion = document.getElementById('form-edicion');
        const modalCancelEdicion = document.getElementById('modal-cancel-edicion');
        const editTipoSelect = document.getElementById('edit-tipo');
        const editCuentaSelect = document.getElementById('edit-cuenta');
        const editCategoriaSelect = document.getElementById('edit-categoria');
        const editMontoInput = document.getElementById('edit-monto');
        const editDescripcionInput = document.getElementById('edit-descripcion');
        const editFechaInput = document.getElementById('edit-fecha');
        const editIdInput = document.getElementById('edit-id');

        
        // --- 3. L√ìGICA DE UTILIDAD Y C√ÅLCULO ---
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('es-US', { style: 'currency', currency: 'USD' }).format(amount);
        };
        
        function calcularSugerenciaAhorro() {
            const tipo = tipoSelect.value;
            const porcentaje = parseFloat(ahorroPorcentajeInput.value) || 0;
            const porcentajeValido = isNaN(porcentaje) || porcentaje < 0 ? 0 : porcentaje;
            
            const ingresosTotales = resumenMensual.ingresosTotales || 0;
            
            const montoSugerido = ingresosTotales * (porcentajeValido / 100);

            document.getElementById('ahorro-sugerencia-monto').textContent = `Sugerencia (${porcentajeValido}% de ${formatCurrency(ingresosTotales)}): ${formatCurrency(montoSugerido)}`;
            
            if (tipo === 'ahorro') {
                ahorroSugerenciaContainer.classList.remove('hidden');
            } else {
                ahorroSugerenciaContainer.classList.add('hidden');
            }
        }
        
        // C√°lculo de saldos simple: Ingresos suman, Gastos/Ahorros restan.
        function calcularSaldosCuentas() {
            const saldos = {};
            cuentas.forEach(c => saldos[c] = 0);
            
            todasTransacciones.forEach(t => {
                if (t.cuenta && saldos.hasOwnProperty(t.cuenta)) {
                    
                    if (t.tipo === 'ingreso') { 
                        saldos[t.cuenta] += t.monto;
                    } 
                    
                    else if (t.tipo === 'gasto' || t.tipo === 'ahorro') { 
                        saldos[t.cuenta] -= t.monto;
                    } 
                }
            });
            return saldos;
        }

        // --- C√ìDIGO CLAVE: CALCULAR RESUMEN MENSUAL Y 50/30/20 ---
        function calcularResumenMensual() {
            let totalEntradasMes = 0;
            let totalSalidasMes = 0;
            
            let ingresosRealesMes = 0;
            
            let gastosPorCategoria = {};
            let ingresosPorCategoria = {};
            let saldoInicial = 0;
            
            // --- VARIABLES 50/30/20 ---
            let gastoNecesidades = 0; // 50%
            let gastoAhorroDeudas = 0; // 20%
            // Categor√≠as asumidas como necesidades (50%)
            const categoriasNecesidades = ['Vivienda', 'Servicios', 'Salud', 'Educaci√≥n', 'Deudas'];
            
            const mesActualSeleccionado = mesSeleccionado;

            todasTransacciones.forEach(t => {
                const monto = t.monto;
                
                // 1. C√ÅLCULO DEL SALDO INICIAL (Transacciones de meses anteriores)
                if (t.mesAnio < mesActualSeleccionado) {
                    if (t.tipo === 'ingreso') {
                        saldoInicial += monto;
                    } else if (t.tipo === 'gasto' || t.tipo === 'ahorro') {
                        saldoInicial -= monto;
                    }
                
                // 2. C√ÅLCULO DEL MES ACTUAL
                } else if (t.mesAnio === mesActualSeleccionado) {
                    
                    // --- Flujos de ENTRADA ---
                    if (t.tipo === 'ingreso') { 
                        totalEntradasMes += monto;
                        ingresosRealesMes += monto;
                        ingresosPorCategoria[t.categoria] = (ingresosPorCategoria[t.categoria] || 0) + monto;
                    
                    // --- Flujos de SALIDA ---
                    } else if (t.tipo === 'gasto' || t.tipo === 'ahorro') {
                        totalSalidasMes += monto; 
                        
                        if (t.tipo === 'gasto') {
                            gastosPorCategoria[t.categoria] = (gastosPorCategoria[t.categoria] || 0) + monto;

                            // Es una necesidad (50%)
                            if (categoriasNecesidades.includes(t.categoria)) {
                                gastoNecesidades += monto;
                            }
                            
                            // Si es Deudas, va al 20%
                            if (t.categoria === 'Deudas') {
                                gastoAhorroDeudas += monto;
                            }

                        } else if (t.tipo === 'ahorro') {
                            // Gastos y Ahorro no van a GastosPorCategoria, ya que no son categor√≠as de gasto tradicional
                            // Es ahorro (20%)
                            gastoAhorroDeudas += monto;
                        }
                    }
                }
            });
            
            const balanceNeto = saldoInicial + totalEntradasMes - totalSalidasMes;
            
            // C√ÅLCULO DEL 30% (Gastos Deseos/Flexibles)
            
            // AhorroPuro: Solo las transacciones de tipo 'ahorro' del mes actual.
            const ahorroPuroMes = transaccionesMesActual.filter(t => t.tipo === 'ahorro').reduce((sum, t) => sum + t.monto, 0);

            // DeudasPuras: Solo las transacciones de categor√≠a 'Deudas' del mes actual.
            const deudasPurasMes = transaccionesMesActual.filter(t => t.tipo === 'gasto' && t.categoria === 'Deudas').reduce((sum, t) => sum + t.monto, 0);

            // Gastos Esenciales Puros (sin deudas): Necesidades - Deudas
            const necesidadesPurasMes = gastoNecesidades - deudasPurasMes;

            // Deseos = (Total Gastos tipo 'gasto') - Necesidades Puras
            const totalGastosTipoGasto = transaccionesMesActual.filter(t => t.tipo === 'gasto').reduce((sum, t) => sum + t.monto, 0);
            
            const gastoDeseos = Math.max(0, totalGastosTipoGasto - necesidadesPurasMes);
            
            // El 20% es la suma de Ahorro y Deudas.
            gastoAhorroDeudas = ahorroPuroMes + deudasPurasMes;

            return { 
                ingresosTotales: ingresosRealesMes, 
                gastosTotales: totalSalidasMes, 
                balanceNeto: balanceNeto, 
                saldoInicial: saldoInicial,
                gastosPorCategoria: gastosPorCategoria, 
                ingresosPorCategoria: ingresosPorCategoria,
                // Valores 50/30/20
                gastoNecesidades: gastoNecesidades, 
                gastoDeseos: gastoDeseos,
                gastoAhorroDeudas: gastoAhorroDeudas // Ahorro + Deudas
            };
        }

        // --- 4. FUNCIONES CRUD CON SUPABASE ---
        
        function guardarConfiguracionLocal() {
            localStorage.setItem('finanzasCategorias', JSON.stringify(categorias));
            localStorage.setItem('finanzasCuentas', JSON.stringify(cuentas));
        }
        
        async function cargarDatosDesdeSupabase() {
            const { data, error } = await supabase
                .from(TABLA_TRANSACCIONES)
                .select('id, tipo, categoria, descripcion, monto, fecha, cuenta'); 
            
            if (error) {
                console.error("Error al cargar datos de Supabase:", error);
                document.getElementById('lista-transacciones').innerHTML = `<tr><td colspan="7" class="p-4 text-center text-red-500">Error al cargar datos: ${error.message}.</td></tr>`;
                todasTransacciones = [];
            } else {
                todasTransacciones = data.map(t => ({
                    ...t,
                    monto: parseFloat(t.monto), 
                    mesAnio: t.fecha.substring(0, 7) 
                }));
            }
            
            filtrarYRenderizar();
        }

        async function guardarTransaccion(transaccion) {
            const { error } = await supabase
                .from(TABLA_TRANSACCIONES)
                .insert([{
                    tipo: transaccion.tipo,
                    categoria: transaccion.categoria,
                    descripcion: transaccion.descripcion,
                    monto: parseFloat(transaccion.monto),
                    fecha: transaccion.fecha,
                    cuenta: transaccion.cuenta, 
                }]);
                
            if (error) {
                console.error("Error al guardar en Supabase:", error);
                return { success: false, error: error };
            } 
            return { success: true };
        }

        async function eliminarTransaccion(id) {
            const { error } = await supabase
                .from(TABLA_TRANSACCIONES)
                .delete()
                .eq('id', id); 

            if (error) {
                console.error("Error al eliminar en Supabase:", error);
            } else {
                await cargarDatosDesdeSupabase();
            }
        }
        
        // --- 5. L√ìGICA DE FILTRADO Y C√ÅLCULO ---

        function filtrarYRenderizar() {
            transaccionesMesActual = todasTransacciones
                .filter(t => t.mesAnio === mesSeleccionado)
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                
            resumenMensual = calcularResumenMensual();

            const { ingresosTotales, gastosTotales, balanceNeto, saldoInicial, gastoNecesidades, gastoDeseos, gastoAhorroDeudas } = resumenMensual;
            renderizarDashboard(ingresosTotales, gastosTotales, balanceNeto, saldoInicial, gastoAhorroDeudas);
            renderizarPlanificador503020(ingresosTotales, gastoNecesidades, gastoDeseos, gastoAhorroDeudas);
            renderizarListaTransacciones();
            calcularSugerenciaAhorro(); 
            renderizarResumenCuentas(); 
        }


        // --- 6. L√ìGICA DE RENDERIZACI√ìN DE LA UI ---
        
        function inicializarSelectorMes() {
            const hoy = new Date();
            const year = hoy.getFullYear();
            const month = hoy.getMonth();
            
            let opcionesHTML = '';
            const mesesNombre = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

            for (let i = -6; i <= 5; i++) {
                const fecha = new Date(year, month + i, 1);
                const valor = `${fecha.getFullYear()}-${(fecha.getMonth() + 1).toString().padStart(2, '0')}`;
                const nombre = `${mesesNombre[fecha.getMonth()]} ${fecha.getFullYear()}`;
                opcionesHTML += `<option value="${valor}">${nombre}</option>`;
            }

            selectorMesEl.innerHTML = opcionesHTML;
            mesSeleccionado = `${year}-${(month + 1).toString().padStart(2, '0')}`;
            selectorMesEl.value = mesSeleccionado;
            fechaInput.value = hoy.toISOString().substring(0, 10);

            selectorMesEl.addEventListener('change', (e) => {
                mesSeleccionado = e.target.value;
                filtrarYRenderizar();
            });
        }
        
        function inicializarPestanas() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.dataset.target;

                    tabContents.forEach(content => content.classList.add('hidden'));
                    tabButtons.forEach(btn => {
                        btn.classList.remove('border-indigo-500', 'text-indigo-600');
                        btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    });

                    document.getElementById(targetId).classList.remove('hidden');
                    button.classList.add('border-indigo-500', 'text-indigo-600');
                    button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

                    if (targetId === 'seccion-categorias') {
                        renderizarCategorias();
                        renderizarCuentas(); 
                    }
                    
                    if (targetId === 'seccion-resumen') {
                        actualizarCategoriasYCuentas(); 
                    }
                });
            });
        }
        
        function renderizarResumenCuentas() {
            const saldos = calcularSaldosCuentas();
            const resumenCuentasEl = document.getElementById('resumen-cuentas');
            resumenCuentasEl.innerHTML = '';
            
            const saldosOrdenados = cuentas.map(c => [c, saldos[c] !== undefined ? saldos[c] : 0]);

            if (saldosOrdenados.length === 0) {
                resumenCuentasEl.innerHTML = '<p class="text-gray-500">No hay cuentas configuradas o transacciones registradas.</p>';
                return;
            }

            saldosOrdenados.forEach(([cuenta, saldo]) => {
                const color = saldo >= 0 ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200';
                const html = `
                    <div class="${color} p-3 rounded-lg border">
                        <p class="text-sm font-semibold">${cuenta}</p>
                        <p class="text-xl font-bold mt-1">${formatCurrency(saldo)}</p>
                    </div>
                `;
                resumenCuentasEl.insertAdjacentHTML('beforeend', html);
            });
        }

        // --- FUNCI√ìN PLANIFICADOR 50/30/20 ---
        function renderizarPlanificador503020(ingresosTotales, gastoNecesidades, gastoDeseos, gastoAhorroDeudas) {
            document.getElementById('ingreso-neto-503020').textContent = formatCurrency(ingresosTotales);
            
            // 1. Calcular Objetivos (Basado en Ingresos Totales del Mes)
            const objetivo50 = ingresosTotales * 0.5;
            const objetivo30 = ingresosTotales * 0.3;
            const objetivo20 = ingresosTotales * 0.2;
            
            document.getElementById('objetivo-50').textContent = formatCurrency(objetivo50);
            document.getElementById('objetivo-30').textContent = formatCurrency(objetivo30);
            document.getElementById('objetivo-20').textContent = formatCurrency(objetivo20);
            
            document.getElementById('gasto-50').textContent = formatCurrency(gastoNecesidades);
            document.getElementById('gasto-30').textContent = formatCurrency(gastoDeseos);
            document.getElementById('gasto-20').textContent = formatCurrency(gastoAhorroDeudas);

            // 2. Calcular Porcentajes de Gasto (respecto al Ingreso Total)
            const pctNecesidades = ingresosTotales > 0 ? (gastoNecesidades / ingresosTotales) * 100 : 0;
            const pctDeseos = ingresosTotales > 0 ? (gastoDeseos / ingresosTotales) * 100 : 0;
            const pctAhorro = ingresosTotales > 0 ? (gastoAhorroDeudas / ingresosTotales) * 100 : 0;
            
            const totalPct = pctNecesidades + pctDeseos + pctAhorro;
            
            // 3. Renderizar Gr√°fico Circular (Anillo)
            const budgetRingEl = document.getElementById('budget-ring');
            
            const visualPct50 = Math.min(pctNecesidades, 50);
            const visualPct30 = Math.min(pctDeseos, 30);
            const visualPct20 = Math.min(pctAhorro, 20);

            const deg50 = (visualPct50 / 100) * 360;
            const deg30 = (visualPct30 / 100) * 360;
            
            const totalConsumedPct = Math.min(totalPct, 100);

            budgetRingEl.style.setProperty('--pct-50', `${deg50}deg`);
            budgetRingEl.style.setProperty('--pct-30', `${deg30}deg`);
            budgetRingEl.setAttribute('data-total', `${totalConsumedPct.toFixed(1)}%`);

            // 4. Colores de los objetivos (Alerta visual)
            const updateColor = (monto, objetivo, id) => {
                const el = document.getElementById(id);
                el.classList.remove('bg-red-200', 'border-red-400', 'bg-orange-200', 'border-orange-400', 'bg-emerald-200', 'border-emerald-400', 'bg-red-100', 'border-red-300', 'bg-red-50', 'bg-orange-50', 'bg-emerald-50', 'border-red-200', 'border-orange-200', 'border-emerald-200');

                if (id === 'box-50' || id === 'box-30') {
                    if (monto > objetivo) {
                        el.classList.add('bg-red-200', 'border-red-400');
                    } else {
                        el.classList.add('bg-red-50', 'border-red-200');
                    }
                } else if (id === 'box-20') {
                    if (monto < objetivo) {
                        el.classList.add('bg-red-100', 'border-red-300'); 
                    } else {
                        el.classList.add('bg-emerald-50', 'border-emerald-200');
                    }
                }
                
                if (id === 'box-50' && monto <= objetivo) el.classList.add('bg-red-50', 'border-red-200');
                if (id === 'box-30' && monto <= objetivo) el.classList.add('bg-orange-50', 'border-orange-200');
                if (id === 'box-20' && monto >= objetivo) el.classList.add('bg-emerald-50', 'border-emerald-200');
            };

            updateColor(gastoNecesidades, objetivo50, 'box-50');
            updateColor(gastoDeseos, objetivo30, 'box-30');
            updateColor(gastoAhorroDeudas, objetivo20, 'box-20');
        }
        // --- FIN FUNCI√ìN PLANIFICADOR 50/30/20 ---


        function renderizarDashboard(ingresosTotales, gastosTotales, balanceNeto, saldoInicial, ahorroGastado) {
            saldoInicialEl.textContent = formatCurrency(saldoInicial);
            ingresosTotalesEl.textContent = formatCurrency(ingresosTotales);
            document.getElementById('gastos-totales').textContent = formatCurrency(gastosTotales);
            document.getElementById('ahorro-gastado-503020').textContent = formatCurrency(ahorroGastado); 
            
            const balanceEl = document.getElementById('balance-neto');
            balanceEl.textContent = formatCurrency(balanceNeto);
            balanceEl.classList.remove('text-green-700', 'text-red-700', 'text-indigo-700');
            if (balanceNeto > 0) balanceEl.classList.add('text-green-700'); 
            else if (balanceNeto < 0) balanceEl.classList.add('text-red-700'); 
            else balanceEl.classList.add('text-indigo-700');

            renderizarGastosPorCategoria(resumenMensual.gastosPorCategoria, resumenMensual.gastosTotales);
            renderizarIngresosPorCategoria(resumenMensual.ingresosPorCategoria, ingresosTotales);
        }

        function renderizarGastosPorCategoria(gastosPorCategoria, gastosTotales) {
            gastosPorCategoriaEl.innerHTML = '';
            // Excluir Ahorros del gr√°fico de categor√≠as de "Gastos" para que solo muestre categor√≠as de Gasto tipo 'gasto'
            const categoriasGastos = Object.entries(gastosPorCategoria).filter(([cat, monto]) => categorias.gasto.includes(cat)); 
            const totalGastosVisual = categoriasGastos.reduce((sum, [, monto]) => sum + monto, 0);

            if (totalGastosVisual === 0) {
                gastosPorCategoriaEl.innerHTML = '<p class="text-gray-500 text-center py-4">No hay transacciones de tipo Gasto registradas en este mes.</p>';
                return;
            }
            const colores = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#0ea5e9', '#6366f1', '#a855f7', '#ec4899', '#f43f5e'];
            let colorIndex = 0;
            const categoriasOrdenadas = categoriasGastos.sort(([, a], [, b]) => b - a);

            categoriasOrdenadas.forEach(([categoria, monto]) => {
                const porcentaje = (monto / totalGastosVisual) * 100;
                const color = colores[colorIndex % colores.length];
                colorIndex++;
                const html = `
                    <div>
                        <div class="flex justify-between text-sm font-medium">
                            <span class="text-gray-700">${categoria}</span>
                            <span class="text-gray-600">${formatCurrency(monto)} (${porcentaje.toFixed(1)}%)</span>
                        </div>
                        <div class="category-bar-container bg-gray-200 mt-1">
                            <div class="category-bar-segment" style="width: ${porcentaje}%; background-color: ${color};"></div>
                        </div>
                    </div>
                `;
                gastosPorCategoriaEl.insertAdjacentHTML('beforeend', html);
            });
        }
        
        function renderizarIngresosPorCategoria(ingresosPorCategoria, ingresosTotales) {
            ingresosPorCategoriaEl.innerHTML = '';
            
            if (ingresosTotales === 0) {
                ingresosPorCategoriaEl.innerHTML = '<p class="text-gray-500 text-center py-4">No hay ingresos registrados en este mes.</p>';
                return;
            }
            
            const colores = ['#22c55e', '#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5']; 
            let colorIndex = 0;
            const categoriasOrdenadas = Object.entries(ingresosPorCategoria).sort(([, a], [, b]) => b - a);

            categoriasOrdenadas.forEach(([categoria, monto]) => {
                const porcentaje = (monto / ingresosTotales) * 100;
                const color = colores[colorIndex % colores.length];
                colorIndex++;
                const html = `
                    <div>
                        <div class="flex justify-between text-sm font-medium">
                            <span class="text-gray-700">${categoria}</span>
                            <span class="text-gray-600">${formatCurrency(monto)} (${porcentaje.toFixed(1)}%)</span>
                        </div>
                        <div class="category-bar-container bg-gray-200 mt-1">
                            <div class="category-bar-segment" style="width: ${porcentaje}%; background-color: ${color};"></div>
                        </div>
                    </div>
                `;
                ingresosPorCategoriaEl.insertAdjacentHTML('beforeend', html);
            });
        }

        function renderizarListaTransacciones() {
            if (transaccionesMesActual.length === 0) {
                listaTransaccionesEl.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">No hay transacciones registradas para este mes.</td></tr>`;
                return;
            }

            listaTransaccionesEl.innerHTML = transaccionesMesActual.map(t => {
                const esIngreso = t.tipo === 'ingreso';
                const esAhorro = t.tipo === 'ahorro';

                let montoClase;
                let tipoClase;
                let tipoTexto;
                let categoriaTexto = t.categoria || 'N/A';

                montoClase = esIngreso ? 'text-green-600 font-semibold' : esAhorro ? 'text-blue-600 font-semibold' : 'text-red-600 font-semibold';
                tipoClase = esIngreso ? 'bg-green-100 text-green-800' : esAhorro ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800';
                tipoTexto = esIngreso ? 'INGRESO' : esAhorro ? 'AHORRO' : 'GASTO';
                
                return `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.fecha}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${tipoClase}">${tipoTexto}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${t.cuenta || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${categoriaTexto}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${t.descripcion}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm ${montoClase}">${formatCurrency(t.monto)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button data-id="${t.id}" class="btn-editar text-indigo-500 hover:text-indigo-700 transition" title="Editar Transacci√≥n">
                                <i data-lucide="pencil" class="w-5 h-5 inline-block"></i>
                            </button>
                            <button data-id="${t.id}" class="btn-eliminar text-red-500 hover:text-red-700 transition" title="Eliminar Transacci√≥n">
                                <i data-lucide="trash-2" class="w-5 h-5 inline-block"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            try {
                createIcons({ icons: window.lucideIcons }); 
            } catch (e) {
                console.warn("Error al renderizar iconos de la tabla:", e.message);
            }
        }

        // --- 7. MANEJO DE EVENTOS ---

        function actualizarCategoriasYCuentas() {
            actualizarCategorias();
            
            const opcionesCuentas = cuentas.map(c => `<option value="${c}">${c}</option>`).join('');
            cuentaSelect.innerHTML = opcionesCuentas;
        }

        function actualizarCategorias() {
            const tipo = tipoSelect.value;
            const cats = categorias[tipo] || [];
            categoriaSelect.innerHTML = cats.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            calcularSugerenciaAhorro(); 
        }
        
        // --- FUNCI√ìN CRUD LOCALES ---
        
        function guardarCuentas() {
            localStorage.setItem('finanzasCuentas', JSON.stringify(cuentas));
        }
        
        // --- EVENT HANDLERS ---
        
        tipoSelect.addEventListener('change', actualizarCategorias);
        document.getElementById('monto').addEventListener('input', calcularSugerenciaAhorro);
        ahorroPorcentajeInput.addEventListener('input', calcularSugerenciaAhorro);

        formTransaccion.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fechaTransaccion = document.getElementById('fecha').value;
            const mesAnioTransaccion = fechaTransaccion.substring(0, 7);

            if (mesAnioTransaccion !== mesSeleccionado) {
                formMessageEl.textContent = `Advertencia: La transacci√≥n es del mes ${mesAnioTransaccion}, pero est√°s viendo ${mesSeleccionado}. Se guardar√°.`;
                formMessageEl.classList.remove('hidden', 'text-green-500');
                formMessageEl.classList.add('text-red-500');
                setTimeout(() => formMessageEl.classList.add('hidden'), 5000);
            }

            const transaccion = {
                tipo: tipoSelect.value,
                categoria: categoriaSelect.value,
                monto: parseFloat(document.getElementById('monto').value),
                descripcion: document.getElementById('descripcion').value.trim(),
                fecha: fechaTransaccion,
                cuenta: cuentaSelect.value,
            };

            if (transaccion.descripcion && transaccion.monto > 0 && transaccion.cuenta) {
                const result = await guardarTransaccion(transaccion);

                if (result.success) {
                    await cargarDatosDesdeSupabase(); 
                    formMessageEl.textContent = "¬°Transacci√≥n guardada con √©xito en la nube!";
                    formMessageEl.classList.remove('hidden', 'text-red-500');
                    formMessageEl.classList.add('text-green-500');
                    formTransaccion.reset();
                    fechaInput.value = new Date().toISOString().substring(0, 10);
                    setTimeout(() => formMessageEl.classList.add('hidden'), 3000);
                } else {
                    formMessageEl.textContent = `Error al guardar: ${result.error.message}.`;
                    formMessageEl.classList.remove('hidden', 'text-green-500');
                    formMessageEl.classList.add('text-red-500');
                }
            } else {
                formMessageEl.textContent = "Por favor, complete todos los campos (incluida la cuenta) correctamente.";
                formMessageEl.classList.remove('hidden', 'text-green-500');
                formMessageEl.classList.add('text-red-500');
            }
        });
        
        // --- LISTENERS DE ACCIONES DE LA TABLA Y MODALES ---

        listaTransaccionesEl.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.btn-eliminar');
            const editButton = e.target.closest('.btn-editar');

            if (deleteButton) {
                const id = deleteButton.dataset.id;
                mostrarModalConfirmacion(id);
            }
            if (editButton) { 
                const id = editButton.dataset.id;
                mostrarModalEdicion(id);
            }
        });

        let idAeliminar = null;
        function mostrarModalConfirmacion(id) {
            idAeliminar = id;
            modalContainerConfirm.classList.remove('hidden');
            modalContainerConfirm.classList.add('flex');
        }

        modalCancelConfirm.addEventListener('click', () => {
            modalContainerConfirm.classList.remove('flex');
            modalContainerConfirm.classList.add('hidden');
            idAeliminar = null;
        });

        modalConfirmDelete.addEventListener('click', () => {
            if (idAeliminar) {
                eliminarTransaccion(idAeliminar);
            }
            modalContainerConfirm.classList.remove('flex');
            modalContainerConfirm.classList.add('hidden');
            idAeliminar = null;
        });
        
        function actualizarOpcionesEdicion(currentTipo, currentCategoria, currentCuenta) {
            
            editCuentaSelect.innerHTML = cuentas.map(c => 
                `<option value="${c}" ${c === currentCuenta ? 'selected' : ''}>${c}</option>`
            ).join('');

            const llenarCategorias = (tipo) => {
                const cats = categorias[tipo] || [];
                editCategoriaSelect.innerHTML = cats.map(cat => 
                    `<option value="${cat}" ${cat === currentCategoria ? 'selected' : ''}>${cat}</option>`
                ).join('');
            };

            editTipoSelect.value = currentTipo;
            llenarCategorias(currentTipo);

            editTipoSelect.onchange = null; 
            editTipoSelect.onchange = () => {
                const nuevoTipo = editTipoSelect.value;
                llenarCategorias(nuevoTipo);
            };
        }
        
        formEdicion.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const transaccionEditada = {
                id: editIdInput.value,
                tipo: editTipoSelect.value,
                cuenta: editCuentaSelect.value,
                categoria: editCategoriaSelect.value,
                monto: parseFloat(editMontoInput.value),
                descripcion: editDescripcionInput.value.trim(),
                fecha: editFechaInput.value,
            };

            if (transaccionEditada.descripcion && transaccionEditada.monto > 0 && transaccionEditada.cuenta) {
                actualizarTransaccionSupabase(transaccionEditada);
            } else {
                alert("Por favor, complete todos los campos correctamente en el formulario de edici√≥n.");
            }
        });
        
        async function actualizarTransaccionSupabase(transaccion) {
             const { error } = await supabase
                .from(TABLA_TRANSACCIONES)
                .update({ 
                    tipo: transaccion.tipo,
                    categoria: transaccion.categoria,
                    monto: transaccion.monto,
                    descripcion: transaccion.descripcion,
                    fecha: transaccion.fecha,
                    cuenta: transaccion.cuenta
                 })
                .eq('id', transaccion.id);

            if (error) {
                console.error("Error al actualizar en Supabase:", error);
                alert("Error al actualizar: " + error.message);
            } else {
                modalContainerEdicion.classList.add('hidden');
                await cargarDatosDesdeSupabase();
            }
        }


        modalCancelEdicion.addEventListener('click', () => {
            modalContainerEdicion.classList.remove('flex');
            modalContainerEdicion.classList.add('hidden');
            editTipoSelect.onchange = null; 
        });
        
        function mostrarModalEdicion(id) {
            const transaccion = todasTransacciones.find(t => t.id === id); 
            if (!transaccion) return;

            editIdInput.value = transaccion.id;
            editMontoInput.value = transaccion.monto.toFixed(2);
            editDescripcionInput.value = transaccion.descripcion;
            editFechaInput.value = transaccion.fecha;
            
            actualizarOpcionesEdicion(transaccion.tipo, transaccion.categoria, transaccion.cuenta);
            
            modalContainerEdicion.classList.remove('hidden');
            modalContainerEdicion.classList.add('flex');
        }

        // --- Funciones para la pesta√±a Administrar Datos (CRUD de Cuentas/Categor√≠as) ---

        function agregarGeneral(tipo, nombre) {
            nombre = nombre.trim();
            if (!nombre) return false;
            
            let array;
            let guardarFn;

            if (tipo === 'cuenta') {
                array = cuentas;
                guardarFn = guardarCuentas;
            } else {
                array = categorias[tipo];
                guardarFn = guardarConfiguracionLocal;
            }
            
            if (!array.includes(nombre)) {
                array.push(nombre); 
                
                guardarFn();
                if (tipo === 'cuenta') renderizarCuentas();
                else renderizarCategorias();
                categoriasInputs[tipo].value = ''; 
                actualizarCategoriasYCuentas(); 
                return true;
            } else {
                alert(`${tipo === 'cuenta' ? 'La cuenta' : 'La categor√≠a'} "${nombre}" ya existe.`);
            }
            return false;
        }

        function eliminarGeneral(tipo, nombre) {
            let array;
            let guardarFn;
            let transaccionKey = tipo === 'cuenta' ? 'cuenta' : 'categoria';

            if (tipo === 'cuenta') {
                array = cuentas;
                guardarFn = guardarCuentas;
            } else {
                array = categorias[tipo];
                guardarFn = guardarConfiguracionLocal;
            }

            const index = array.indexOf(nombre);
            if (index > -1) {
                const transaccionesActivas = todasTransacciones.filter(t => t[transaccionKey] === nombre);
                
                if (transaccionesActivas.length > 0) {
                    alert(`No se puede eliminar porque tiene ${transaccionesActivas.length} transacciones registradas. Elimina las transacciones primero.`);
                    return false;
                }
                
                array.splice(index, 1);
                guardarFn();
                if (tipo === 'cuenta') renderizarCuentas();
                else renderizarCategorias();
                actualizarCategoriasYCuentas(); 
                return true;
            }
            return false;
        }

        function renderizarCuentas() { 
            const listaEl = categoriasListas['cuenta'];
            const countEl = categoriasCounts['cuenta'];
            listaEl.innerHTML = '';
            
            cuentas.forEach((cuenta) => {
                const listItem = document.createElement('li');
                
                listItem.dataset.nombre = cuenta;
                listItem.className = `flex justify-between items-center p-3 rounded-lg border bg-gray-50`;
                
                listItem.innerHTML = `
                    <span class="text-gray-800" data-cuenta="${cuenta}">${cuenta}</span>
                    <div>
                        <button data-tipo="cuenta" data-nombre="${cuenta}" class="btn-eliminar-general text-red-400 hover:text-red-600 transition" title="Eliminar Cuenta">
                            <i data-lucide="x-circle" class="w-5 h-5 inline-block"></i>
                        </button>
                    </div>
                `;
                listaEl.appendChild(listItem);
            });

            countEl.textContent = `(${cuentas.length} cuentas)`;
            try { createIcons({ icons: window.lucideIcons }); } catch(e) {}
        }
        
        function renderizarCategorias() {
            Object.keys(categorias).forEach(tipo => {
                const listaEl = categoriasListas[tipo];
                const countEl = categoriasCounts[tipo];
                listaEl.innerHTML = '';
                categorias[tipo].forEach(categoria => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg border';
                    listItem.innerHTML = `
                        <span class="text-gray-800">${categoria}</span>
                        <button data-tipo="${tipo}" data-nombre="${categoria}" class="btn-eliminar-general text-red-400 hover:text-red-600 transition" title="Eliminar Categor√≠a">
                            <i data-lucide="x-circle" class="w-5 h-5 inline-block"></i>
                        </button>
                    `;
                    listaEl.appendChild(listItem);
                });
                
                countEl.textContent = `(${categorias[tipo].length} categor√≠as)`;
            });
            try { createIcons({ icons: window.lucideIcons }); } catch(e) {}
        }

        // --- 8. INICIO DE LA APLICACI√ìN ---
        
        inicializarPestanas(); 
        inicializarSelectorMes();
        actualizarCategoriasYCuentas(); 
        cargarDatosDesdeSupabase(); 

        try {
            createIcons({ icons: window.lucideIcons });
        } catch(e) {
            console.warn("Error al cargar iconos principales. La aplicaci√≥n funcionar√°, pero los iconos pueden faltar.", e.message);
        }
    </script>
</body>
</html>
